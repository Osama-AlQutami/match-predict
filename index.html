<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osama – Mohammad Predictions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--danger:#ef4444;--border:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 30%);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center}
    .brand{display:flex;gap:12px;align-items:center}
    .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(34,211,238,.15)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:#0b1220;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .chip[disabled]{opacity:.5;cursor:not-allowed}
    input{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .btn{background:var(--accent);border:none;color:#0b1220;font-weight:700;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#1f2937;color:var(--text)}
    .grid{display:grid;gap:10px}
    .grid.matches{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .muted{color:var(--muted)} .title{font-size:22px;font-weight:700} .small{font-size:12px}
    .center{text-align:center} .hidden{display:none} .kbd{font-family:ui-monospace,Menlo,monospace;background:#0b1220;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border)}
    #debug{background:#111827;border:1px dashed #374151;border-radius:10px;padding:10px;margin-bottom:10px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="container">
    <div id="debug" class="hidden"></div>

    <header>
      <div class="brand"><div class="dot"></div>
        <div>
          <div style="font-weight:700">Osama – Mohammad Predictions</div>
          <div class="muted small">لعبة توقع نتائج المباريات — مجانية 100%</div>
        </div>
      </div>
      <div class="row">
        <button id="btnLogin" class="chip">تسجيل / دخول</button>
        <button id="btnLogout" class="chip hidden">تسجيل خروج</button>
      </div>
    </header>

    <!-- Auth -->
    <section id="authCard" class="card hidden" style="margin-top:12px">
      <div class="title">حسابك</div>
      <div class="row" style="margin-top:8px">
        <input id="email" placeholder="الإيميل" type="email"/>
        <input id="password" placeholder="كلمة السر" type="password"/>
        <button id="doSignup" class="btn">إنشاء حساب</button>
        <button id="doSignin" class="btn secondary">دخول</button>
      </div>
      <div class="muted small" style="margin-top:8px">نستعمل Supabase مجانًا للمصادقة وتخزين النتائج.</div>
    </section>

    <!-- Settings -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">الإعدادات</div>
        <div id="whoami" class="muted small">—</div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="competitionIds" placeholder="أمثلة: WC-CL-PD-PL أو PL فقط" style="min-width:260px"/>
        <input id="teamIds" placeholder="IDs الفرق (اختياري، مفصولة بفواصل)" style="min-width:260px"/>
        <button id="saveScope" class="btn">حفظ الفرق/المسابقات</button>
      </div>
      <div class="muted small" style="margin-top:6px">
        نستعمل API مجاني من football-data.org — حط التوكن تبعك تحت. <span class="pill">ضروري</span>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="footballToken" placeholder="Football-Data API Token" style="min-width:360px"/>
        <button id="saveToken" class="chip">حفظ التوكن محليًا</button>
        <button id="showTeamIds" class="chip">عرض IDs الفرق للمسابقات</button>
      </div>
      <div id="teamsList" class="muted small" style="margin-top:8px;white-space:pre-wrap"></div>
    </section>

    <!-- Matches -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">المباريات القادمة</div>
        <div class="muted small">التوقع مسموح حتى <span class="kbd">T-10m</span> قبل انطلاق المباراة.</div>
      </div>
      <div id="matches" class="grid matches" style="margin-top:10px"></div>
      <div id="noMatches" class="center muted hidden" style="margin-top:10px">لا يوجد مباريات ضمن النطاق الحالي.</div>
    </section>

    <!-- Leaderboard -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">الترتيب</div>
        <button id="recalc" class="chip">تحديث النقاط اليدوي</button>
      </div>
      <div id="board" style="margin-top:8px"></div>
    </section>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  /**** ===== إعدادات Supabase ===== ****/
  const SUPABASE_URL  = "https://wbxofuuwabwqurvbgfae.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndieG9mdXV3YWJ3cXVydmJnZmFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTUxNzQsImV4cCI6MjA3MTE5MTE3NH0.a45JBtzQI8so9z3lZ__aypUIafmhxeUOCkmBmbtQOHg";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /**** ===== Helpers ===== ****/
  const FOOTBALL_BASE = 'https://api.football-data.org/v4';
  const $ = (sel)=>document.querySelector(sel);
  const debugEl = $('#debug');
  function show(msg){ debugEl.textContent = msg; debugEl.classList.remove('hidden'); }
  function clearDebug(){ debugEl.classList.add('hidden'); debugEl.textContent = ''; }

  const getToken = ()=> localStorage.getItem('FOOTBALL_TOKEN') || '';
  const saveToken = (t)=> localStorage.setItem('FOOTBALL_TOKEN', t);
  function parseComps(s){ return (s||'WC,CL,PD,PL').replace(/-/g,',').split(',').map(x=>x.trim()).filter(Boolean); }
  const fmtTime = (iso)=> new Date(iso).toLocaleString('ar-JO');

  function lockReason(kickoffISO){
    const k = new Date(kickoffISO).getTime();
    const diffMin = (k - Date.now()) / 60000;
    if(diffMin <= 10) return `مغلق (باقي ${Math.max(0, Math.floor(diffMin))} دقيقة)`;
    return null;
  }
  function pointsFor(pred, result){
    if(!result || result.status !== 'FINISHED') return 0;
    const ph=pred.home_goals, pa=pred.away_goals;
    const rh=result.home_goals, ra=result.away_goals;
    const predSign = Math.sign(ph-pa), realSign = Math.sign(rh-ra);
    if(ph===rh && pa===ra) return 3;
    if(predSign===realSign) return 1;
    return 0;
  }

  async function refreshUser(){
    const { data: { user } } = await supabase.auth.getUser();
    const who = $('#whoami');
    if(user){
      $('#btnLogin').classList.add('hidden');
      $('#btnLogout').classList.remove('hidden');
      who.textContent = `مسجل: ${user.email}`;
      $('#authCard').classList.add('hidden');
    }else{
      $('#btnLogin').classList.remove('hidden');
      $('#btnLogout').classList.add('hidden');
      who.textContent = 'غير مسجل';
    }
  }

  async function fetchCompMatches(comp){
    const token = getToken();
    const headers = token? { 'X-Auth-Token': token } : {};
    const now = new Date();
    const from = now.toISOString().slice(0,10);
    const to   = new Date(now.getTime()+7*864e5).toISOString().slice(0,10);
    const url  = `${FOOTBALL_BASE}/competitions/${encodeURIComponent(comp)}/matches?dateFrom=${from}&dateTo=${to}`;
    const res  = await fetch(url,{headers});
    if(!res.ok){
      let msg = `API ${res.status}`; try{ const j=await res.json(); if(j && (j.message||j.error)) msg += ` — ${j.message||j.error}`; }catch(_){}
      throw new Error(`${msg} (المسابقة: ${comp})`);
    }
    const json = await res.json();
    return json.matches || [];
  }

  async function fetchCompTeams(comp){
    const token = getToken(); const headers = token? { 'X-Auth-Token': token } : {};
    const res = await fetch(`${FOOTBALL_BASE}/competitions/${encodeURIComponent(comp)}/teams`, {headers});
    if(!res.ok){
      let msg = `API ${res.status}`; try{ const j=await res.json(); if(j && (j.message||j.error)) msg += ` — ${j.message||j.error}`; }catch(_){}
      throw new Error(`${msg} (teams: ${comp})`);
    }
    const j = await res.json(); return (j.teams||[]).map(t=>({id:t.id,name:t.name,tla:t.tla}));
  }

  function renderMatchCard(m){
    const lock = lockReason(m.utcDate);
    const card = document.createElement('div');
    card.className = 'card';
    const kickoff = fmtTime(m.utcDate);
    const mid = m.id;
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="title">${m.homeTeam.name} <span class="muted">vs</span> ${m.awayTeam.name}</div>
          <div class="muted small">${m.competition.name} • ${kickoff}</div>
        </div>
        <div class="pill ${lock? 'muted':''}">${lock? lock : 'مفتوح للتوقع'}</div>
      </div>
      <div class="row" style="margin-top:8px;align-items:center">
        <input type="number" min="0" id="h_${mid}" placeholder="${m.homeTeam.tla||'H'}" style="width:90px">
        <span class="muted">—</span>
        <input type="number" min="0" id="a_${mid}" placeholder="${m.awayTeam.tla||'A'}" style="width:90px">
        <button class="btn" id="s_${mid}">حفظ التوقع</button>
      </div>`;
    $('#matches').appendChild(card);
    card.querySelector(`#s_${mid}`).addEventListener('click', ()=> savePrediction(m));
    if(lock){ card.querySelector(`#s_${mid}`).disabled = true; }
  }

  async function savePrediction(m){
    const h = parseInt(document.getElementById(`h_${m.id}`).value, 10);
    const a = parseInt(document.getElementById(`a_${m.id}`).value, 10);
    if(Number.isNaN(h)||Number.isNaN(a)) return alert('حط النتيجة للطرفين');
    const lock = lockReason(m.utcDate); if(lock) return alert('انتهى الوقت للتوقع');
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) return alert('سجل دخول بالأول');
    const row = { user_id: user.id, match_id: String(m.id), home_goals: h, away_goals: a, kickoff: new Date(m.utcDate).toISOString(), comp_id: m.competition.code || m.competition.id, team_home: m.homeTeam.name, team_away: m.awayTeam.name };
    const {error} = await supabase.from('predictions').upsert(row, {onConflict: 'user_id,match_id'});
    alert(error? error.message : 'انحفظ التوقع ✌️');
  }

  async function renderLeaderboard(){
    const {data: preds} = await supabase.from('predictions').select('*');
    const {data: res}   = await supabase.from('results').select('*');
    const map = new Map((res||[]).map(r=>[r.match_id, r]));
    const totals = new Map();
    for(const p of (preds||[])){ const r = map.get(p.match_id); const pts = pointsFor(p, r); totals.set(p.user_id, (totals.get(p.user_id)||0) + pts); }
    const ids = [...totals.keys()]; const users = {};
    for(const id of ids){ const {data} = await supabase.from('profiles').select('id,username').eq('id', id).maybeSingle(); users[id] = data?.username || id.slice(0,8); }
    const sorted = [...totals.entries()].sort((a,b)=> b[1]-a[1]);
    $('#board').innerHTML = sorted.map(([uid,pts],i)=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:8px 0">
        <div>#${i+1} • ${users[uid]}</div><div><strong>${pts}</strong> نقطة</div>
      </div>`).join('') || '<div class="muted">لا يوجد نقاط بعد.</div>';
  }

  async function loadMatches(){
    clearDebug();
    $('#matches').innerHTML = ''; $('#noMatches').classList.add('hidden');

    const comps = parseComps($('#competitionIds').value || localStorage.getItem('COMP_IDS'));
    if(!comps || !comps.length){ $('#noMatches').classList.remove('hidden'); $('#noMatches').textContent='أدخل كود مسابقة أولاً (PL مثلاً)'; return; }
    localStorage.setItem('COMP_IDS', comps.join(','));

    try{
      let all = [];
      for(const c of comps){
        try{ all = all.concat(await fetchCompMatches(c)); }
        catch(e){ show(e.message); }
      }
      const teamFilter = ($('#teamIds').value||localStorage.getItem('TEAM_IDS')||'').split(',').map(x=>x.trim()).filter(Boolean);
      if(teamFilter.length){ all = all.filter(m=> teamFilter.includes(String(m.homeTeam.id)) || teamFilter.includes(String(m.awayTeam.id)) ); }
      all = all.filter(m=> ['TIMED','SCHEDULED'].includes(m.status));
      if(!all.length){ $('#noMatches').classList.remove('hidden'); return; }
      all.sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate));
      all.forEach(renderMatchCard);
    }catch(e){ show('خطأ عام: '+e.message); }
  }

  async function listTeams(){
    const comps = parseComps($('#competitionIds').value || localStorage.getItem('COMP_IDS'));
    if(!comps || !comps.length) return alert('أدخل كود مسابقة أولاً');
    $('#teamsList').textContent = 'جارِ الجلب...';
    let txt='';
    for(const c of comps){
      try{
        const t = await fetchCompTeams(c);
        if(!t.length){ txt += `${c}: لا يوجد/تعذر الجلب\n`; continue; }
        txt += `${c}:\n` + t.map(x=>`  ${x.id} — ${x.name}${x.tla? ' ('+x.tla+')':''}`).join('\n') + '\n';
      }catch(e){ txt += `${c}: ${e.message}\n`; }
    }
    $('#teamsList').textContent = txt || 'لا يوجد بيانات.';
  }

  // Attach listeners AFTER DOM is ready
  function init(){
    // Global error box
    window.addEventListener('error', (e)=> show('JS Error: '+ e.message));
    window.addEventListener('unhandledrejection', (e)=> show('Promise Error: '+ (e.reason?.message||e.reason)));

    // Auth buttons
    $('#btnLogin').addEventListener('click', ()=> $('#authCard').classList.toggle('hidden'));
    $('#btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); await refreshUser(); });
    $('#doSignup').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signUp({email,password}); alert(error? error.message : 'تم إنشاء الحساب'); refreshUser(); });
    $('#doSignin').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signInWithPassword({email,password}); alert(error? error.message : 'تم الدخول'); refreshUser(); });

    // Settings buttons
    $('#saveScope').addEventListener('click', ()=>{ localStorage.setItem('COMP_IDS', ($('#competitionIds').value||'').replace(/-/g,',')); localStorage.setItem('TEAM_IDS', $('#teamIds').value||''); loadMatches(); });
    $('#saveToken').addEventListener('click', ()=>{ saveToken($('#footballToken').value); loadMatches(); });
    $('#showTeamIds').addEventListener('click', listTeams);

    // Prefill inputs
    $('#competitionIds').value = (localStorage.getItem('COMP_IDS') || 'WC,CL,PD,PL').replace(/,/g,', ');
    $('#teamIds').value        = (localStorage.getItem('TEAM_IDS') || '');
    $('#footballToken').value  = getToken();

    refreshUser();
    loadMatches();
    renderLeaderboard();
  }
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
