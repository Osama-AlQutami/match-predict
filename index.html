<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osama â€“ Mohammad Predictions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;--bg2:#0f172a;--card:#0e1627;--muted:#a5b4c3;--text:#e8eef6;
      --accent:#22d3ee;--accent2:#10b981;--danger:#ef4444;--border:#1e293b;
      --ring:rgba(34,211,238,.35);--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    [data-theme="light"]{
      --bg:#f6f8fc;--bg2:#eef2f8;--card:#ffffff;--muted:#5b6574;--text:#0b1220;
      --accent:#0ea5e9;--accent2:#059669;--danger:#dc2626;--border:#e5e7eb;--ring:rgba(14,165,233,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:radial-gradient(1200px 600px at 0 0, rgba(34,211,238,.06), transparent 40%),
               radial-gradient(900px 500px at 100% 0, rgba(16,185,129,.06), transparent 40%),
               linear-gradient(180deg,var(--bg),var(--bg2) 35%);
      color:var(--text);font-family:"Tajawal",system-ui,Arial
    }
    .container{max-width:1050px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg, rgba(0,0,0,.35), transparent);backdrop-filter:blur(6px);display:flex;gap:12px;justify-content:space-between;align-items:center;padding:10px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 8px var(--ring)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;transition:.2s}
    .chip:hover{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
    .chip[disabled]{opacity:.5;cursor:not-allowed}
    input,select{
      background:transparent;color:var(--text);border:1px solid var(--border);
      border-radius:12px;padding:8px 10px;outline:none;transition:.2s
    }
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 5px var(--ring)}
    .btn{
      background:linear-gradient(90deg,var(--accent),#7dd3fc);
      border:none;color:#06121a;font-weight:800;border-radius:12px;padding:9px 14px;cursor:pointer;transition:transform .06s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#1f2a3a;color:var(--text)}
    .btn.success{background:linear-gradient(90deg,var(--accent2),#34d399);color:#062a23}
    .btn.danger{background:linear-gradient(90deg,var(--danger),#fb7185);color:white}
    .muted{color:var(--muted)} .title{font-size:20px;font-weight:800} .small{font-size:12px}
    .center{text-align:center} .hidden{display:none}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:transparent;border:1px dashed var(--border);padding:2px 6px;border-radius:6px}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-size:12px}

    /* Cards */
    .card{
      position:relative;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--card);
      border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);
      backdrop-filter:saturate(140%) blur(4px); margin-top:12px
    }
    .card::after{
      content:"";position:absolute;inset:-1px;border-radius:16px;padding:1px;
      background:linear-gradient(135deg,rgba(34,211,238,.35),rgba(16,185,129,.2),transparent);
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none
    }

    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-top:6px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;background:transparent;cursor:pointer}
    .tab.active{background:var(--card);box-shadow:var(--shadow)}

    /* Matches grid */
    .grid{display:grid;gap:10px}
    .grid.matches{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    @media (max-width:600px){ .grid.matches{grid-template-columns:1fr} }

    /* Compact Match Card */
    .match{display:flex;flex-direction:column;gap:8px}
    .match-head{display:flex;justify-content:space-between;align-items:center}
    .teams{display:flex;flex-direction:column;gap:6px}
    .team{display:grid;grid-template-columns:auto 1fr 58px;gap:8px;align-items:center}
    .team img{width:22px;height:22px;object-fit:contain;background:transparent;border:1px solid var(--border);border-radius:8px}
    .team input{width:58px;text-align:center;font-weight:800}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .vs{color:var(--muted);font-size:12px;margin:0 4px}

    /* Tables */
    .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:right}
    .table tr:nth-child(odd){background:rgba(255,255,255,.02)}
    .ok{color:#10b981}.bad{color:#ef4444}

    /* Leaderboard medals */
    #board > .row{position:relative;padding-right:30px}
    #board > .row:nth-child(1)::before{content:"ğŸ¥‡";position:absolute;right:6px;top:6px}
    #board > .row:nth-child(2)::before{content:"ğŸ¥ˆ";position:absolute;right:6px;top:6px}
    #board > .row:nth-child(3)::before{content:"ğŸ¥‰";position:absolute;right:6px;top:6px}

    /* Floating Save on mobile */
    @media (max-width:640px){
      #saveAll{position:fixed;right:16px;bottom:16px;z-index:50;border-radius:999px;padding:14px 18px;
        box-shadow:0 14px 40px rgba(0,0,0,.35)}
    }

    /* Toast */
    #toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;z-index:60;pointer-events:none}
    .toast{
      background:linear-gradient(180deg,rgba(255,255,255,.06),transparent), var(--card);
      border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:12px;
      box-shadow:var(--shadow);min-width:260px;text-align:center;pointer-events:auto;animation:pop .18s ease-out
    }
    .toast.ok{border-color:rgba(16,185,129,.6)}
    .toast.err{border-color:rgba(239,68,68,.7)}
    @keyframes pop{from{transform:translateY(10px);opacity:.0}to{transform:translateY(0);opacity:1}}
  </style>
</head>
<body>
  <div id="toast"></div>
  <div class="container">

    <header>
      <div class="brand"><div class="dot"></div>
        <div>
          <div style="font-weight:700">Osama â€“ Mohammad Predictions</div>
          <div class="muted small">Ù„Ø¹Ø¨Ø© ØªÙˆÙ‚Ø¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª â€” Ù…Ø¬Ø§Ù†ÙŠØ© 100%</div>
        </div>
      </div>
      <div class="row">
        <button id="toggleTheme" class="chip" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">ğŸŒ™</button>
        <button id="btnLogin" class="chip">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
        <button id="btnLogout" class="chip hidden">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-tab="history">Ø§Ù„Ø³Ø¬Ù„</button>
      <button class="tab" data-tab="mine">Ø³ÙØ¬Ù„ÙŠ</button>
    </div>

    <!-- Auth -->
    <section id="authCard" class="card hidden">
      <div class="title">Ø­Ø³Ø§Ø¨Ùƒ</div>
      <div class="row" style="margin-top:8px">
        <input id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" type="email"/>
        <input id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password"/>
        <button id="doSignup" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button id="doSignin" class="btn secondary">Ø¯Ø®ÙˆÙ„</button>
        <button id="forgot" class="chip">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</button>
      </div>
      <div class="muted small" style="margin-top:8px">
        Ø²Ø± Â«Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±Â» Ø³ÙŠØ±Ø³Ù„ Ù„Ùƒ Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ ØµÙØ­Ø© <code>reset.html</code> ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹.
      </div>
    </section>

    <!-- Fixed scope summary -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">Ø§Ù„Ù†Ø·Ø§Ù‚</div>
        <div id="whoami" class="muted small">â€”</div>
      </div>
      <div class="muted small">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª: <strong>PD, CL, PL</strong> â€¢ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: <strong id="fixedTeamCount">â€”</strong></div>
    </section>

    <!-- TAB: Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <section id="tab-home" class="tab-pane">
      <!-- Matches -->
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="title">Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
          <div class="row">
            <div class="muted small">Ø§Ù„ØªÙˆÙ‚Ø¹ Ù…Ø³Ù…ÙˆØ­ Ø­ØªÙ‰ <span class="kbd">T-10m</span></div>
            <button id="saveAll" class="btn success">Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</button>
          </div>
        </div>
        <div id="matches" class="grid matches" style="margin-top:6px"></div>
        <div id="noMatches" class="center muted hidden" style="margin-top:10px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø¶Ù…Ù† Ù¤ Ø£ÙŠØ§Ù… Ù‚Ø§Ø¯Ù…Ø©.</div>
      </section>

      <!-- Leaderboard -->
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="title">Ø§Ù„ØªØ±ØªÙŠØ¨</div>
          <button id="recalc" class="chip">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠØ¯ÙˆÙŠ</button>
        </div>
        <div id="board" style="margin-top:6px"></div>
      </section>
    </section>

    <!-- TAB: Ø§Ù„Ø³Ø¬Ù„ (Ù…ØªØ³Ø§Ø¨Ù‚ ÙˆØ§Ø­Ø¯) -->
    <section id="tab-history" class="tab-pane hidden">
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="title">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
          <div class="row">
            <select id="userPick" title="Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚"></select>
            <select id="weekPick" title="Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹"></select>
            <button id="loadWeek" class="chip">Ø¹Ø±Ø¶</button>
          </div>
        </div>
        <div id="weekly" style="margin-top:8px"></div>
      </section>
    </section>

    <!-- TAB: Ø³ÙØ¬Ù„ÙŠ -->
    <section id="tab-mine" class="tab-pane hidden">
      <section class="card">
        <div class="title">Ø³ÙØ¬Ù„ÙŠ (Ù…Ø­ÙÙˆØ¸ ÙˆÙ„Ù… ÙŠØ¨Ø¯Ø£)</div>
        <div id="myUpcoming" style="margin-top:8px"></div>
      </section>
    </section>

  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  /**** ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase Ùˆ Edge Function ===== ****/
  const SUPABASE_URL  = "https://wbxofuuwabwqurvbgfae.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndieG9mdXV3YWJ3cXVydmJnZmFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTUxNzQsImV4cCI6MjA3MTE5MTE3NH0.a45JBtzQI8so9z3lZ__aypUIafmhxeUOCkmBmbtQOHg";
  const EDGE_BASE     = "https://wbxofuuwabwqurvbgfae.supabase.co/functions/v1/bright-function"; // proxy

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const edgeHeaders = { 'Authorization': `Bearer ${SUPABASE_ANON}`, 'apikey': SUPABASE_ANON };

  /**** ===== Ù†Ø·Ø§Ù‚ Ø«Ø§Ø¨Øª ===== ****/
  const FIXED_COMP_CODES = ['PD','CL','PL'];
  const FIXED_TEAM_IDS = [
    81,86,4,5,524,57,58,61,62,63,64,65,66,67,71,73,76,328,341,351,354,397,402,563,1044
  ];
  document.getElementById('fixedTeamCount').textContent = String(FIXED_TEAM_IDS.length);

  /**** ===== Helpers & UI ===== ****/
  const $ = (sel)=>document.querySelector(sel);
  const fmtTime = (iso)=> new Date(iso).toLocaleString('en-GB', { hour12:false });
  const crest = (id)=> `https://crests.football-data.org/${id}.svg`;

  function toast(msg, type='ok', t=2200){
    const host=$('#toast'); if(!host) return alert(msg);
    const el=document.createElement('div'); el.className='toast '+(type==='err'?'err':'ok'); el.textContent=msg;
    host.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(10px)'; }, t);
    setTimeout(()=>host.removeChild(el), t+280);
  }
  window.alert = (m)=>toast(m,'ok');

  // Theme toggle
  (function themeInit(){
    const key='MP_THEME', saved=localStorage.getItem(key);
    if(saved) document.documentElement.setAttribute('data-theme', saved);
    const btn=$('#toggleTheme');
    if(btn){
      const assign=()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; btn.textContent = cur==='light' ? 'ğŸŒ™' : 'â˜€ï¸'; };
      btn.onclick=()=>{ const cur=document.documentElement.getAttribute('data-theme')==='light'?'dark':'light'; document.documentElement.setAttribute('data-theme',cur); localStorage.setItem(key, cur); assign(); };
      assign();
    }
  })();

  // Tabs
  const TABS = ['home','history','mine'];
  function switchTab(name){
    TABS.forEach(t=>{
      document.querySelector(`[data-tab="${t}"]`).classList.toggle('active', t===name);
      document.getElementById('tab-'+t).classList.toggle('hidden', t!==name);
    });
    localStorage.setItem('MP_TAB', name);
  }
  document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click',()=> switchTab(b.dataset.tab)));
  switchTab(localStorage.getItem('MP_TAB')||'home');

  function lockReason(kickoffISO){
    const k = new Date(kickoffISO).getTime();
    const diffMin = (k - Date.now()) / 60000;
    if(diffMin <= 10) return `Ù…ØºÙ„Ù‚ (Ø¨Ø§Ù‚ÙŠ ${Math.max(0, Math.floor(diffMin))} Ø¯Ù‚ÙŠÙ‚Ø©)`;
    return null;
  }

  function pointsFor(pred, result){
    if(!result || result.status !== 'FINISHED') return 0;
    const ph=pred.home_goals, pa=pred.away_goals;
    const rh=result.home_goals, ra=result.away_goals;
    const predSign = Math.sign(ph-pa), realSign = Math.sign(rh-ra);
    if(ph===rh && pa===ra) return 3;
    if(predSign===realSign) return 1;
    return 0;
  }

  let USER=null;
  const userPreds = new Map();  // match_id -> prediction
  const matchesMap = new Map(); // match_id -> match (Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
  let PROFILES = [];            // {id, username}

  async function refreshUser(){
    const { data: { user } } = await supabase.auth.getUser();
    USER = user || null;
    const who = $('#whoami');
    if(user){
      $('#btnLogin').classList.add('hidden');
      $('#btnLogout').classList.remove('hidden');
      who.textContent = `Ù…Ø³Ø¬Ù„: ${user.email}`;
      $('#authCard').classList.add('hidden');
      await supabase.from('profiles').upsert({ id:user.id, username:user.email });
    }else{
      $('#btnLogin').classList.remove('hidden');
      $('#btnLogout').classList.add('hidden');
      who.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    }
  }

  // API: next 4 days
  async function fetchCompMatches(comp){
    const now  = new Date();
    const from = now.toISOString().slice(0,10);
    const to   = new Date(now.getTime()+4*864e5).toISOString().slice(0,10);
    const url  = `${EDGE_BASE}/competitions/${encodeURIComponent(comp)}/matches?dateFrom=${from}&dateTo=${to}`;
    const res  = await fetch(url, { headers: edgeHeaders });
    if(!res.ok){
      let msg = `API ${res.status}`; try{ const j = await res.json(); if(j && (j.message||j.error)) msg += ` â€” ${j.message||j.error}`; }catch(_){}
      throw new Error(`${msg} (Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: ${comp})`);
    }
    const json = await res.json();
    return (json.matches || []).filter(m => ['TIMED','SCHEDULED'].includes(m.status));
  }
  async function fetchMatchesRange(fromISO, toISO){
    let all = [];
    for(const c of FIXED_COMP_CODES){
      const url  = `${EDGE_BASE}/competitions/${encodeURIComponent(c)}/matches?dateFrom=${fromISO}&dateTo=${toISO}`;
      const res  = await fetch(url, { headers: edgeHeaders });
      if(res.ok){
        const json = await res.json();
        all = all.concat(json.matches||[]);
      }
    }
    return all;
  }

  function renderMatchCard(m){
    const lock = lockReason(m.utcDate);
    const card = document.createElement('div');
    card.className = 'card match';
    const kickoff = fmtTime(m.utcDate);
    const mid = String(m.id);
    const saved = userPreds.get(mid);

    matchesMap.set(mid, m);

    card.innerHTML = `
      <div class="match-head">
        <div class="pill ${lock? 'muted':''}" id="pill_${mid}">${lock? lock : (saved? 'Ù…Ø­ÙÙˆØ¸' : 'Ù…ÙØªÙˆØ­')}</div>
        <div class="muted small">${m.competition.name} â€¢ ${kickoff}</div>
      </div>

      <div class="teams">
        <div class="team">
          <img src="${crest(m.homeTeam.id)}" alt="">
          <div>${m.homeTeam.name}</div>
          <input type="number" min="0" id="h_${mid}" placeholder="0">
        </div>
        <div class="team">
          <img src="${crest(m.awayTeam.id)}" alt="">
          <div>${m.awayTeam.name}</div>
          <input type="number" min="0" id="a_${mid}" placeholder="0">
        </div>
      </div>
    `;
    $('#matches').appendChild(card);

    if(saved){
      card.querySelector(`#h_${mid}`).value = saved.home_goals;
      card.querySelector(`#a_${mid}`).value = saved.away_goals;
      card.querySelector(`#h_${mid}`).disabled = true;
      card.querySelector(`#a_${mid}`).disabled = true;
    }
    if(lock){
      card.querySelector(`#h_${mid}`).disabled = true;
      card.querySelector(`#a_${mid}`).disabled = true;
    }
  }

  async function saveAll(){
    if(!USER) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø£ÙˆÙ„');
    const rows = [];
    document.querySelectorAll('[id^="h_"]').forEach(inp=>{
      const mid = inp.id.slice(2);
      const a = document.getElementById(`a_${mid}`);
      const pillTxt = document.getElementById(`pill_${mid}`).textContent;
      const locked = pillTxt.startsWith('Ù…ØºÙ„Ù‚');
      if(locked) return;
      if(userPreds.has(mid)) return; // Ù„Ø§ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      const hV = parseInt(inp.value,10), aV = parseInt(a.value,10);
      if(Number.isNaN(hV)||Number.isNaN(aV)) return;
      const m = matchesMap.get(mid);
      rows.push({
        user_id: USER.id,
        match_id: mid,
        home_goals: hV,
        away_goals: aV,
        kickoff: m ? new Date(m.utcDate).toISOString() : new Date().toISOString(),
        comp_id: m?.competition?.code || null,
        team_home: m?.homeTeam?.name || null,
        team_away: m?.awayTeam?.name || null
      });
    });
    if(!rows.length) return alert('Ù…Ø§ ÙÙŠ ØªÙˆÙ‚Ø¹Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ÙØ¸');
    const { error } = await supabase.from('predictions').insert(rows);
    if(error){
      alert('Ø§Ù†Ø­ÙØ¸Øª Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (ØªØ¬Ø§Ù‡Ù„Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§)');
    }else{
      alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœŒï¸');
    }
    await loadUserPreds(); markSavedOnUI(); renderMyUpcoming();
  }

  function markSavedOnUI(){
    document.querySelectorAll('[id^="h_"]').forEach(inp=>{
      const mid = inp.id.slice(2);
      const saved = userPreds.get(mid);
      if(saved){
        inp.value = saved.home_goals;
        const a = document.getElementById(`a_${mid}`);
        a.value = saved.away_goals;
        inp.disabled = true; a.disabled = true;
        const pill = document.getElementById('pill_'+mid); if(pill) pill.textContent = 'Ù…Ø­ÙÙˆØ¸';
      }
    });
  }

  // Leaderboard (shows all profiles)
  async function renderLeaderboard(){
    const [profsRes, predsRes, resRes] = await Promise.all([
      supabase.from('profiles').select('id,username'),
      supabase.from('predictions').select('*'),
      supabase.from('results').select('*')
    ]);
    const profs   = PROFILES = profsRes.data || [];
    const preds   = predsRes.data || [];
    const results = resRes.data   || [];
    const rmap = new Map(results.map(r => [String(r.match_id), r]));
    const totals = new Map();

    for(const p of preds){
      const r = rmap.get(String(p.match_id));
      const pts = pointsFor(p, r);
      totals.set(p.user_id, (totals.get(p.user_id)||0) + pts);
    }
    for(const prof of profs){
      if(!totals.has(prof.id)) totals.set(prof.id, 0);
    }
    const names = {}; for(const prof of profs){ names[prof.id] = prof.username || prof.id.slice(0,8); }
    const sorted = [...totals.entries()].sort((a,b)=>(b[1]-a[1]) || (names[a[0]]||'').localeCompare(names[b[0]]||''));

    $('#board').innerHTML = sorted.map(([uid,pts],i)=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:6px 0">
        <div>#${i+1} â€¢ ${names[uid]||uid.slice(0,8)}</div>
        <div><strong>${pts}</strong> Ù†Ù‚Ø·Ø©</div>
      </div>`).join('') || '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯.</div>';

    // Ø¹Ø¨Ù‘ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„Ø³Ø¬Ù„"
    const up = $('#userPick');
    if(up){
      const cur = up.value;
      up.innerHTML = profs.map(p=>`<option value="${p.id}">${p.username||p.id.slice(0,8)}</option>`).join('');
      if(cur) up.value = cur; // Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ùˆ Ù…ØªØ§Ø­
      else if(USER) up.value = USER.id;
    }
  }

  async function loadUserPreds(){
    if(!USER){ userPreds.clear(); return; }
    const {data} = await supabase.from('predictions')
      .select('match_id,home_goals,away_goals,kickoff,team_home,team_away')
      .eq('user_id', USER.id);
    userPreds.clear();
    (data||[]).forEach(p=> userPreds.set(String(p.match_id), p));
  }

  // Ø³ÙØ¬Ù„ÙŠ
  async function renderMyUpcoming(){
    if(!USER){ $('#myUpcoming').innerHTML = '<div class="muted">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ùƒ.</div>'; return; }
    const now = new Date(); const in4 = new Date(now.getTime()+4*864e5);
    const mine = [...userPreds.values()].filter(p=> new Date(p.kickoff) > now && new Date(p.kickoff) <= in4 );
    if(!mine.length){ $('#myUpcoming').innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙ‚Ø¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¶Ù…Ù† Ù¤ Ø£ÙŠØ§Ù….</div>'; return; }
    $('#myUpcoming').innerHTML = `
      <table class="table">
        <thead><tr><th>Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</th><th>Ø§Ù„ØªÙˆÙ‚Ø¹</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
        <tbody id="myUpcomingBody"></tbody>
      </table>`;
    const body = $('#myUpcomingBody');
    for(const p of mine){
      const m = matchesMap.get(String(p.match_id));
      const label = m ? `${m.homeTeam.name} vs ${m.awayTeam.name}` : `${p.team_home||''} vs ${p.team_away||''}`.trim();
      body.insertAdjacentHTML('beforeend',
        `<tr><td>${label}</td><td>${p.home_goals} â€“ ${p.away_goals}</td><td>${fmtTime(p.kickoff)}</td></tr>`);
    }
  }

  // Ø§Ù„Ø³Ø¬Ù„: Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø­Ø¯ + Ø£Ø³Ø¨ÙˆØ¹
  function startOfWeek(d){ const dt = new Date(d); const day = (dt.getDay()+6)%7; dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day); return dt; }
  function endOfWeek(s){ const e=new Date(s); e.setDate(e.getDate()+7); return e; }
  function fillWeekPicker(){
    const now = new Date();
    const cur = startOfWeek(now); const prev = new Date(cur); prev.setDate(cur.getDate()-7);
    const sel = $('#weekPick');
    sel.innerHTML = `
      <option value="cur">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (${cur.toLocaleDateString('en-GB')})</option>
      <option value="prev">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ (${prev.toLocaleDateString('en-GB')})</option>`;
  }
  async function renderWeeklyOne(){
    const uid = $('#userPick').value;
    const pick = $('#weekPick').value;
    const base = pick==='prev'? startOfWeek(new Date(new Date().setDate(new Date().getDate()-7))) : startOfWeek(new Date());
    const from = base.toISOString().slice(0,10), to = endOfWeek(base).toISOString().slice(0,10);

    const [{data: preds}, {data: res}] = await Promise.all([
      supabase.from('predictions').select('*').eq('user_id', uid).gte('kickoff', base.toISOString()).lt('kickoff', endOfWeek(base).toISOString()),
      supabase.from('results').select('*')
    ]);

    const rmap  = new Map((res||[]).map(r=>[String(r.match_id), r]));
    const weekMatches = await fetchMatchesRange(from, to);
    const wmap = new Map(weekMatches.map(m=>[String(m.id), m]));

    let total = 0;
    const rows = (preds||[]).map(p=>{
      const mid = String(p.match_id);
      const m = wmap.get(mid);
      const label = m ? `${m.homeTeam.name} vs ${m.awayTeam.name}` : `${p.team_home||''} vs ${p.team_away||''}`.trim() || mid;
      const r = rmap.get(mid) || (m && m.status==='FINISHED' && m.score ? {
        match_id: mid, home_goals: m.score.fullTime.home, away_goals: m.score.fullTime.away, status: m.status
      } : null);
      const resText = r ? `${r.home_goals} â€“ ${r.away_goals}` : 'â€”';
      const pts = pointsFor(p, r); total += pts;
      const cls = r ? (pts>0? 'ok':'bad') : '';
      return `<tr><td>${label}</td><td>${p.home_goals} â€“ ${p.away_goals}</td><td>${resText}</td><td class="${cls}">${r? pts : ''}</td></tr>`;
    }).join('');

    const user = PROFILES.find(x=>x.id===uid);
    $('#weekly').innerHTML = `
      <div class="title">${user?.username || uid.slice(0,8)} â€” <span class="muted small">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total}</span></div>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</th><th>Ø§Ù„ØªÙˆÙ‚Ø¹</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
        <tbody>${rows||''}</tbody>
      </table>
    ` || '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.</div>';
  }

  // Start
  function init(){
    // Auth
    $('#btnLogin').addEventListener('click', ()=> $('#authCard').classList.toggle('hidden'));
    $('#btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); await refreshUser(); });
    $('#doSignup').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signUp({email,password}); alert(error? error.message : 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'); refreshUser(); });
    $('#doSignin').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signInWithPassword({email,password}); alert(error? error.message : 'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„'); refreshUser(); });

    const SITE_RESET_URL = location.origin + location.pathname.replace(/\/[^/]*$/, '/reset.html');
    $('#forgot').addEventListener('click', async ()=>{
      const email=$('#email').value.trim(); if(!email) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: SITE_RESET_URL });
      alert(error? error.message : 'Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¨Ø±ÙŠØ¯Ùƒ.');
    });

    // Buttons
    $('#saveAll').addEventListener('click', saveAll);
    $('#recalc').addEventListener('click', async ()=>{
      // ØªØ­Ø¯ÙŠØ« Ù†ØªØ§Ø¦Ø¬ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
      const now = new Date(); const from = new Date(now.getTime()-7*864e5).toISOString().slice(0,10); const to = now.toISOString().slice(0,10);
      for(const c of FIXED_COMP_CODES){
        try{
          const url = `${EDGE_BASE}/competitions/${encodeURIComponent(c)}/matches?dateFrom=${from}&dateTo=${to}`;
          const res = await fetch(url, { headers: edgeHeaders });
          if(!res.ok) continue; const json = await res.json();
          const finished = (json.matches||[]).filter(x=> x.status==='FINISHED');
          for(const m of finished){
            await supabase.from('results').upsert({
              match_id: String(m.id),
              home_goals: m.score?.fullTime?.home,
              away_goals: m.score?.fullTime?.away,
              status: m.status
            });
          }
        }catch(_){}
      }
      renderLeaderboard(); renderWeeklyOne();
    });

    // History tab controls
    $('#loadWeek').addEventListener('click', renderWeeklyOne);
    $('#userPick').addEventListener('change', renderWeeklyOne);
    $('#weekPick').addEventListener('change', renderWeeklyOne);

    // Errors to toast
    window.addEventListener('error', (e)=> toast('JS Error: '+ e.message, 'err', 3000));
    window.addEventListener('unhandledrejection', (e)=> toast('Promise Error: '+ (e.reason?.message||e.reason), 'err', 3000));

    (async function start(){
      await refreshUser();
      await loadUserPreds();

      // Load matches (4 days & filter teams)
      let all = [];
      try{
        for(const c of FIXED_COMP_CODES){ all = all.concat(await fetchCompMatches(c)); }
      }catch(e){ toast(e.message, 'err', 3500); }
      const wanted = new Set(FIXED_TEAM_IDS.map(String));
      all = all.filter(m=> wanted.has(String(m.homeTeam.id)) || wanted.has(String(m.awayTeam.id)) );
      all.sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate));
      if(!all.length){ $('#noMatches').classList.remove('hidden'); }
      else { all.forEach(renderMatchCard); }
      // mark saved
      markSavedOnUI();

      // Leaderboard + profiles + history pickers
      await renderLeaderboard();
      fillWeekPicker();
      await renderWeeklyOne();

      // My upcoming
      await renderMyUpcoming();
    })();
  }
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
