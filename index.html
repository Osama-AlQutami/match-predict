<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osama â€“ Mohammad Predictions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220;--bg2:#0f172a;--card:#0e1627;--muted:#a5b4c3;--text:#e8eef6;
    --accent:#22d3ee;--accent2:#10b981;--danger:#ef4444;--border:#1e293b;
    --ring:rgba(34,211,238,.35);--shadow:0 10px 30px rgba(0,0,0,.35)
  }
  /* Light theme */
  [data-theme="light"]{
    --bg:#f6f8fc;--bg2:#eef2f8;--card:#ffffff;--muted:#5b6574;--text:#0b1220;
    --accent:#0ea5e9;--accent2:#059669;--danger:#dc2626;--border:#e5e7eb;--ring:rgba(14,165,233,.35);
  }

  *{box-sizing:border-box}
  body{
    margin:0;background:radial-gradient(1200px 600px at 0 0, rgba(34,211,238,.06), transparent 40%),
             radial-gradient(900px 500px at 100% 0, rgba(16,185,129,.06), transparent 40%),
             linear-gradient(180deg,var(--bg),var(--bg2) 35%);
    color:var(--text);font-family:"Tajawal",system-ui,Arial
  }
  .container{max-width:1050px;margin:0 auto;padding:20px}
  header{display:flex;gap:12px;justify-content:space-between;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 8px var(--ring)}
  .card{
    position:relative;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),
              var(--card);
    border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow);
    backdrop-filter:saturate(140%) blur(4px)
  }
  .card::after{ /* Ø®Ø· Ù…ØªØ¯Ø±Ø¬ Ù„Ø·ÙŠÙ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ© */
    content:"";position:absolute;inset:-1px;border-radius:18px;
    padding:1px;background:linear-gradient(135deg,rgba(34,211,238,.35),rgba(16,185,129,.2),transparent);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;transition:.2s}
  .chip:hover{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
  .chip[disabled]{opacity:.5;cursor:not-allowed}
  input,select{
    background:transparent;color:var(--text);border:1px solid var(--border);
    border-radius:12px;padding:9px 12px;outline:none;transition:.2s
  }
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 5px var(--ring)}
  .btn{
    background:linear-gradient(90deg,var(--accent),#7dd3fc);
    border:none;color:#06121a;font-weight:800;border-radius:12px;padding:10px 16px;cursor:pointer;transition:transform .06s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#1f2a3a;color:var(--text)}
  .btn.success{background:linear-gradient(90deg,var(--accent2),#34d399);color:#062a23}
  .btn.danger{background:linear-gradient(90deg,var(--danger),#fb7185);color:white}

  .grid{display:grid;gap:12px}
  .grid.matches{grid-template-columns:repeat(auto-fill,minmax(310px,1fr))}
  .muted{color:var(--muted)} .title{font-size:22px;font-weight:800} .small{font-size:12px}
  .center{text-align:center} .hidden{display:none}
  .kbd{font-family:ui-monospace,Menlo,monospace;background:transparent;border:1px dashed var(--border);padding:2px 6px;border-radius:6px}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
  .team{display:flex;align-items:center;gap:8px}
  .team img{width:26px;height:26px;object-fit:contain;background:transparent;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
  .score input{width:46px;text-align:center;font-weight:800}
  #debug{background:transparent;border:1px dashed var(--border);border-radius:12px;padding:10px;margin-bottom:10px;white-space:pre-wrap}

  .section-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

  /* Ø¬Ø¯ÙˆÙ„ Ø¹Ø§Ù… */
  .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  .table th,.table td{border-bottom:1px solid var(--border);padding:10px 10px;text-align:right}
  .table tr:nth-child(odd){background:rgba(255,255,255,.02)}
  .ok{color:#10b981}.bad{color:#ef4444}

  /* Ù…Ø¯Ø§Ù„ÙŠØ§Øª Ø§Ù„ØªØ±ØªÙŠØ¨ */
  #board > .row{position:relative;padding-right:30px}
  #board > .row:nth-child(1)::before{content:"ğŸ¥‡";position:absolute;right:6px;top:6px}
  #board > .row:nth-child(2)::before{content:"ğŸ¥ˆ";position:absolute;right:6px;top:6px}
  #board > .row:nth-child(3)::before{content:"ğŸ¥‰";position:absolute;right:6px;top:6px}

  /* Ø²Ø± Ø­ÙØ¸ ÙŠØ·ÙÙˆ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  @media (max-width:640px){
    #saveAll{position:fixed;right:16px;bottom:16px;z-index:50;border-radius:999px;padding:14px 18px;
      box-shadow:0 14px 40px rgba(0,0,0,.35)}
  }

  /* Toast */
  #toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;z-index:60;pointer-events:none}
  .toast{
    background:linear-gradient(180deg,rgba(255,255,255,.06),transparent), var(--card);
    border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:12px;
    box-shadow:var(--shadow);min-width:260px;text-align:center;pointer-events:auto;animation:pop .18s ease-out
  }
  .toast.ok{border-color:rgba(16,185,129,.6)}
  .toast.err{border-color:rgba(239,68,68,.7)}
  @keyframes pop{from{transform:translateY(10px);opacity:.0}to{transform:translateY(0);opacity:1}}
</style>

</head>
<body>
  <div class="container">
    <div id="debug" class="hidden"></div>

    <header>
      <div class="brand"><div class="dot"></div>
        <div>
          <div style="font-weight:700">Osama â€“ Mohammad Predictions</div>
          <div class="muted small">Ù„Ø¹Ø¨Ø© ØªÙˆÙ‚Ø¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª â€” Ù…Ø¬Ø§Ù†ÙŠØ© 100%</div>
        </div>
      </div>
      <div class="row">
        <button id="btnLogin" class="chip">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
        <button id="btnLogout" class="chip hidden">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Auth -->
    <section id="authCard" class="card hidden" style="margin-top:12px">
      <div class="title">Ø­Ø³Ø§Ø¨Ùƒ</div>
      <div class="row" style="margin-top:8px">
        <input id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" type="email"/>
        <input id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password"/>
        <button id="doSignup" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button id="doSignin" class="btn secondary">Ø¯Ø®ÙˆÙ„</button>
        <button id="forgot" class="chip">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</button>
      </div>
      <div class="muted small" style="margin-top:8px">
        Ø²Ø± Â«Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±Â» Ø³ÙŠØ±Ø³Ù„ Ù„Ùƒ Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ ØµÙØ­Ø© <code>reset.html</code> ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹.
      </div>
    </section>

    <!-- Fixed scope summary -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">Ø§Ù„Ù†Ø·Ø§Ù‚</div>
        <div id="whoami" class="muted small">â€”</div>
      </div>
      <div class="muted small">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª: <strong>PD, CL, PL</strong> â€¢ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: <strong id="fixedTeamCount">â€”</strong></div>
    </section>

    <!-- Matches -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
        <div class="row">
          <div class="muted small">Ø§Ù„ØªÙˆÙ‚Ø¹ Ù…Ø³Ù…ÙˆØ­ Ø­ØªÙ‰ <span class="kbd">T-10m</span></div>
          <button id="saveAll" class="btn success">Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</button>
        </div>
      </div>
      <div id="matches" class="grid matches"></div>
      <div id="noMatches" class="center muted hidden" style="margin-top:10px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø¶Ù…Ù† Ù¤ Ø£ÙŠØ§Ù… Ù‚Ø§Ø¯Ù…Ø©.</div>
    </section>

    <!-- My upcoming saved predictions -->
    <section class="card" style="margin-top:12px">
      <div class="section-head"><div class="title">Ø³ÙØ¬Ù„ÙŠ (Ù…Ø­ÙÙˆØ¸ ÙˆÙ„Ù… ÙŠØ¨Ø¯Ø£)</div></div>
      <div id="myUpcoming"></div>
    </section>

    <!-- Weekly history (all players) -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
        <div class="row">
          <select id="weekPick"></select>
          <button id="loadWeek" class="chip">Ø¹Ø±Ø¶</button>
        </div>
      </div>
      <div id="weekly"></div>
    </section>

    <!-- Leaderboard -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">Ø§Ù„ØªØ±ØªÙŠØ¨</div>
        <button id="recalc" class="chip">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠØ¯ÙˆÙŠ</button>
      </div>
      <div id="board"></div>
    </section>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  /**** ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase Ùˆ Edge Function ===== ****/
  const SUPABASE_URL  = "https://wbxofuuwabwqurvbgfae.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndieG9mdXV3YWJ3cXVydmJnZmFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTUxNzQsImV4cCI6MjA3MTE5MTE3NH0.a45JBtzQI8so9z3lZ__aypUIafmhxeUOCkmBmbtQOHg";
  const EDGE_BASE     = "https://wbxofuuwabwqurvbgfae.supabase.co/functions/v1/bright-function"; // proxy

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const edgeHeaders = { 'Authorization': `Bearer ${SUPABASE_ANON}`, 'apikey': SUPABASE_ANON };

  /**** ===== Ù†Ø·Ø§Ù‚ Ø«Ø§Ø¨Øª ===== ****/
  const FIXED_COMP_CODES = ['PD','CL','PL'];
  const FIXED_TEAM_IDS = [
    81,86,4,5,524,57,58,61,62,63,64,65,66,67,71,73,76,328,341,351,354,397,402,563,1044
  ];
  document.getElementById('fixedTeamCount').textContent = String(FIXED_TEAM_IDS.length);

  /**** ===== Helpers ===== ****/
  const $ = (sel)=>document.querySelector(sel);
  const debugEl = $('#debug');
  function show(msg){ debugEl.textContent = msg; debugEl.classList.remove('hidden'); }
  function clearDebug(){ debugEl.classList.add('hidden'); debugEl.textContent = ''; }

  // ÙˆÙ‚Øª Ø¨Ø£Ø±Ù‚Ø§Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  const fmtTime = (iso)=> new Date(iso).toLocaleString('en-GB', { hour12:false });
  const crest = (id)=> `https://crests.football-data.org/${id}.svg`;

  function lockReason(kickoffISO){
    const k = new Date(kickoffISO).getTime();
    const diffMin = (k - Date.now()) / 60000;
    if(diffMin <= 10) return `Ù…ØºÙ„Ù‚ (Ø¨Ø§Ù‚ÙŠ ${Math.max(0, Math.floor(diffMin))} Ø¯Ù‚ÙŠÙ‚Ø©)`;
    return null;
  }

  function pointsFor(pred, result){
    if(!result || result.status !== 'FINISHED') return 0;
    const ph=pred.home_goals, pa=pred.away_goals;
    const rh=result.home_goals, ra=result.away_goals;
    const predSign = Math.sign(ph-pa), realSign = Math.sign(rh-ra);
    if(ph===rh && pa===ra) return 3;
    if(predSign===realSign) return 1;
    return 0;
  }

  let USER=null;                       // user object
  const userPreds = new Map();         // match_id -> prediction
  const matchesMap = new Map();        // match_id -> match

  async function refreshUser(){
    const { data: { user } } = await supabase.auth.getUser();
    USER = user || null;
    const who = $('#whoami');
    if(user){
      $('#btnLogin').classList.add('hidden');
      $('#btnLogout').classList.remove('hidden');
      who.textContent = `Ù…Ø³Ø¬Ù„: ${user.email}`;
      $('#authCard').classList.add('hidden');
      // Ø®Ø²Ù‘Ù†/Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙÙŠ profiles Ù„ÙƒÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨
      await supabase.from('profiles').upsert({ id:user.id, username:user.email });
    }else{
      $('#btnLogin').classList.remove('hidden');
      $('#btnLogout').classList.add('hidden');
      who.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    }
  }

  // ===== Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª (Ù¤ Ø£ÙŠØ§Ù… ÙÙ‚Ø·) =====
  async function fetchCompMatches(comp){
    const now  = new Date();
    const from = now.toISOString().slice(0,10);
    const to   = new Date(now.getTime()+4*864e5).toISOString().slice(0,10);
    const url  = `${EDGE_BASE}/competitions/${encodeURIComponent(comp)}/matches?dateFrom=${from}&dateTo=${to}`;
    const res  = await fetch(url, { headers: edgeHeaders });
    if(!res.ok){
      let msg = `API ${res.status}`; try{ const j = await res.json(); if(j && (j.message||j.error)) msg += ` â€” ${j.message||j.error}`; }catch(_){}
      throw new Error(`${msg} (Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: ${comp})`);
    }
    const json = await res.json();
    return (json.matches || []).filter(m => ['TIMED','SCHEDULED'].includes(m.status));
  }

  // Ø¬Ù„Ø¨ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù„ÙØªØ±Ø© Ù…Ø¹ÙŠÙ‘Ù†Ø© (Ù„Ù„Ø§Ø³Ø¨ÙˆØ¹ÙŠ)
  async function fetchMatchesRange(fromISO, toISO){
    let all = [];
    for(const c of FIXED_COMP_CODES){
      const url  = `${EDGE_BASE}/competitions/${encodeURIComponent(c)}/matches?dateFrom=${fromISO}&dateTo=${toISO}`;
      const res  = await fetch(url, { headers: edgeHeaders });
      if(res.ok){
        const json = await res.json();
        all = all.concat(json.matches||[]);
      }
    }
    return all;
  }

  function renderMatchCard(m){
    const lock = lockReason(m.utcDate);
    const card = document.createElement('div');
    card.className = 'card';
    const kickoff = fmtTime(m.utcDate);
    const mid = String(m.id);
    const saved = userPreds.get(mid);

    matchesMap.set(mid, m);

    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="row">
            <div class="team"><img src="${crest(m.homeTeam.id)}" alt=""><span>${m.homeTeam.name}</span></div>
            <span class="muted">vs</span>
            <div class="team"><img src="${crest(m.awayTeam.id)}" alt=""><span>${m.awayTeam.name}</span></div>
          </div>
          <div class="muted small">${m.competition.name} â€¢ ${kickoff}</div>
        </div>
        <div class="pill ${lock? 'muted':''}" id="pill_${mid}">${lock? lock : (saved? 'Ù…Ø­ÙÙˆØ¸' : 'Ù…ÙØªÙˆØ­')}</div>
      </div>
      <div class="row score" style="margin-top:8px">
        <input type="number" min="0" id="h_${mid}" placeholder="${m.homeTeam.tla||'H'}">
        <span class="muted">â€”</span>
        <input type="number" min="0" id="a_${mid}" placeholder="${m.awayTeam.tla||'A'}">
      </div>
    `;
    $('#matches').appendChild(card);

    if(saved){
      card.querySelector(`#h_${mid}`).value = saved.home_goals;
      card.querySelector(`#a_${mid}`).value = saved.away_goals;
      card.querySelector(`#h_${mid}`).disabled = true;
      card.querySelector(`#a_${mid}`).disabled = true;
    }
    if(lock){
      card.querySelector(`#h_${mid}`).disabled = true;
      card.querySelector(`#a_${mid}`).disabled = true;
    }
  }

  async function saveAll(){
    if(!USER) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø£ÙˆÙ„');
    const rows = [];
    document.querySelectorAll('[id^="h_"]').forEach(inp=>{
      const mid = inp.id.slice(2);
      const a = document.getElementById(`a_${mid}`);
      const pillTxt = document.getElementById(`pill_${mid}`).textContent;
      const locked = pillTxt.startsWith('Ù…ØºÙ„Ù‚');
      if(locked) return;
      if(userPreds.has(mid)) return; // Ù„Ø§ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      const hV = parseInt(inp.value,10), aV = parseInt(a.value,10);
      if(Number.isNaN(hV)||Number.isNaN(aV)) return;
      const m = matchesMap.get(mid);
      rows.push({
        user_id: USER.id,
        match_id: mid,
        home_goals: hV,
        away_goals: aV,
        kickoff: m ? new Date(m.utcDate).toISOString() : new Date().toISOString(),
        comp_id: m?.competition?.code || null,
        team_home: m?.homeTeam?.name || null,
        team_away: m?.awayTeam?.name || null
      });
    });
    if(!rows.length) return alert('Ù…Ø§ ÙÙŠ ØªÙˆÙ‚Ø¹Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ÙØ¸');
    const { error } = await supabase.from('predictions').insert(rows);
    if(error){
      alert('Ø§Ù†Ø­ÙØ¸Øª Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (ØªØ¬Ø§Ù‡Ù„Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§)');
    }else{
      alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœŒï¸');
    }
    await loadUserPreds(); markSavedOnUI(); renderMyUpcoming();
  }

  function markSavedOnUI(){
    document.querySelectorAll('[id^="h_"]').forEach(inp=>{
      const mid = inp.id.slice(2);
      const saved = userPreds.get(mid);
      if(saved){
        inp.value = saved.home_goals;
        const a = document.getElementById(`a_${mid}`);
        a.value = saved.away_goals;
        inp.disabled = true; a.disabled = true;
        const pill = document.getElementById('pill_'+mid); if(pill) pill.textContent = 'Ù…Ø­ÙÙˆØ¸';
      }
    });
  }

  // ====== LEADERBOARD (ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø­ØªÙ‰ Ù„Ùˆ 0 Ù†Ù‚Ø·Ø©) ======
  async function renderLeaderboard(){
    const [profsRes, predsRes, resRes] = await Promise.all([
      supabase.from('profiles').select('id,username'),
      supabase.from('predictions').select('*'),
      supabase.from('results').select('*')
    ]);

    const profs   = profsRes.data || [];
    const preds   = predsRes.data || [];
    const results = resRes.data   || [];

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ¹Ù„ÙŠØ©
    const rmap = new Map(results.map(r => [String(r.match_id), r]));

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª
    const totals = new Map();
    for(const p of preds){
      const r = rmap.get(String(p.match_id));
      const pts = pointsFor(p, r);
      totals.set(p.user_id, (totals.get(p.user_id)||0) + pts);
    }

    // ØªØ£ÙƒØ¯ Ø¥Ø¯Ø±Ø§Ø¬ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­ØªÙ‰ Ù„Ùˆ 0
    for(const prof of profs){
      if(!totals.has(prof.id)) totals.set(prof.id, 0);
    }

    // Ø£Ø³Ù…Ø§Ø¡
    const names = {};
    for(const prof of profs){
      names[prof.id] = prof.username || prof.id.slice(0,8);
    }

    // ØªØ±ØªÙŠØ¨
    const sorted = [...totals.entries()].sort((a,b) =>
      (b[1]-a[1]) || (names[a[0]]||'').localeCompare(names[b[0]]||'')
    );

    const html = sorted.map(([uid,pts],i)=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:6px 0">
        <div>#${i+1} â€¢ ${names[uid]||uid.slice(0,8)}</div>
        <div><strong>${pts}</strong> Ù†Ù‚Ø·Ø©</div>
      </div>`).join('');

    document.querySelector('#board').innerHTML = html || '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯.</div>';
  }

  async function loadUserPreds(){
    if(!USER){ userPreds.clear(); return; }
    const {data} = await supabase.from('predictions')
      .select('match_id,home_goals,away_goals,kickoff,team_home,team_away')
      .eq('user_id', USER.id);
    userPreds.clear();
    (data||[]).forEach(p=> userPreds.set(String(p.match_id), p));
  }

  // Ø³ÙØ¬Ù„ÙŠ (Ù…Ø­ÙÙˆØ¸ ÙˆÙ„Ù… ÙŠØ¨Ø¯Ø£)
  async function renderMyUpcoming(){
    if(!USER){ $('#myUpcoming').innerHTML = '<div class="muted">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ùƒ.</div>'; return; }
    const now = new Date(); const in4 = new Date(now.getTime()+4*864e5);
    const mine = [...userPreds.values()].filter(p=> new Date(p.kickoff) > now && new Date(p.kickoff) <= in4 );
    if(!mine.length){ $('#myUpcoming').innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙ‚Ø¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¶Ù…Ù† Ù¤ Ø£ÙŠØ§Ù….</div>'; return; }
    $('#myUpcoming').innerHTML = `
      <table class="table">
        <thead><tr><th>Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</th><th>Ø§Ù„ØªÙˆÙ‚Ø¹</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
        <tbody id="myUpcomingBody"></tbody>
      </table>`;
    const body = document.getElementById('myUpcomingBody');
    for(const p of mine){
      const m = matchesMap.get(String(p.match_id));
      const label = m ? `${m.homeTeam.name} vs ${m.awayTeam.name}` : `${p.team_home||''} vs ${p.team_away||''}`.trim();
      body.insertAdjacentHTML('beforeend',
        `<tr><td>${label}</td><td>${p.home_goals} â€“ ${p.away_goals}</td><td>${fmtTime(p.kickoff)}</td></tr>`);
    }
  }

  // Weekly history (all users) Ù…Ø¹ Ø§Ù„ØªÙˆÙ‚Ø¹ + Ø§Ù„Ù†ØªÙŠØ¬Ø© + Ø§Ù„Ù†Ù‚Ø§Ø·
  function startOfWeek(d){
    const dt = new Date(d); const day = (dt.getDay()+6)%7; // Monday=0
    dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day); return dt;
  }
  function endOfWeek(s){ const e=new Date(s); e.setDate(e.getDate()+7); return e; }
  function fillWeekPicker(){
    const now = new Date();
    const cur = startOfWeek(now); const prev = new Date(cur); prev.setDate(cur.getDate()-7);
    const sel = document.getElementById('weekPick');
    sel.innerHTML = `
      <option value="cur">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (${cur.toLocaleDateString('en-GB')})</option>
      <option value="prev">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ (${prev.toLocaleDateString('en-GB')})</option>`;
  }
  async function renderWeekly(){
    const pick = document.getElementById('weekPick').value;
    const base = pick==='prev'? startOfWeek(new Date(new Date().setDate(new Date().getDate()-7))) : startOfWeek(new Date());
    const from = base.toISOString().slice(0,10), to = endOfWeek(base).toISOString().slice(0,10);

    const [predsRes, resRes] = await Promise.all([
      supabase.from('predictions').select('*').gte('kickoff', base.toISOString()).lt('kickoff', endOfWeek(base).toISOString()),
      supabase.from('results').select('*')
    ]);
    const preds = predsRes.data || [];
    const res   = resRes.data   || [];
    const rmap  = new Map(res.map(r=>[String(r.match_id), r]));
    const weekMatches = await fetchMatchesRange(from, to);
    const wmap = new Map(weekMatches.map(m=>[String(m.id), m]));

    // group by user
    const byUser = new Map();
    for(const p of preds){ const arr = byUser.get(p.user_id)||[]; arr.push(p); byUser.set(p.user_id, arr); }

    // emails
    const names = {};
    for(const uid of byUser.keys()){
      const {data} = await supabase.from('profiles').select('id,username').eq('id', uid).maybeSingle();
      names[uid] = data?.username || uid.slice(0,8);
    }

    let html = '';
    for(const [uid,list] of byUser.entries()){
      let total=0;
      const rows = list.map(p=>{
        const mid = String(p.match_id);
        const m = wmap.get(mid);
        const label = m ? `${m.homeTeam.name} vs ${m.awayTeam.name}`
                        : `${p.team_home||''} vs ${p.team_away||''}`.trim() || mid;

        const r = rmap.get(mid) || (m && m.status==='FINISHED' && m.score ? {
          match_id: mid,
          home_goals: m.score.fullTime.home,
          away_goals: m.score.fullTime.away,
          status: m.status
        } : null);

        const resText = r ? `${r.home_goals} â€“ ${r.away_goals}` : 'â€”';
        const pts = pointsFor(p, r); total += pts;
        const cls = r ? (pts>0? 'ok':'bad') : '';
        return `<tr><td>${label}</td><td>${p.home_goals} â€“ ${p.away_goals}</td><td>${resText}</td><td class="${cls}">${r? pts : ''}</td></tr>`;
      }).join('');

      html += `<div class="title" style="margin-top:6px">${names[uid]||uid.slice(0,8)} â€” <span class="muted small">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total}</span></div>
        <table class="table" style="margin:6px 0 12px 0">
          <thead><tr><th>Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</th><th>Ø§Ù„ØªÙˆÙ‚Ø¹</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
          <tbody>${rows||''}</tbody>
        </table>`;
    }
    $('#weekly').innerHTML = html || '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.</div>';
  }

  // ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© =====
  async function loadMatches(){
    clearDebug();
    $('#matches').innerHTML = ''; $('#noMatches').classList.add('hidden'); matchesMap.clear();

    let all = [];
    for(const c of FIXED_COMP_CODES){
      try{ all = all.concat(await fetchCompMatches(c)); }
      catch(e){ show(e.message); }
    }
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø«Ø§Ø¨ØªØ©
    const wanted = new Set(FIXED_TEAM_IDS.map(String));
    all = all.filter(m=> wanted.has(String(m.homeTeam.id)) || wanted.has(String(m.awayTeam.id)) );
    if(!all.length){ $('#noMatches').classList.remove('hidden'); return; }
    all.sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate));
    all.forEach(renderMatchCard);
    markSavedOnUI();
  }

  function init(){
    window.addEventListener('error', (e)=> show('JS Error: '+ e.message));
    window.addEventListener('unhandledrejection', (e)=> show('Promise Error: '+ (e.reason?.message||e.reason)));

    // Auth
    $('#btnLogin').addEventListener('click', ()=> $('#authCard').classList.toggle('hidden'));
    $('#btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); await refreshUser(); });
    $('#doSignup').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signUp({email,password}); alert(error? error.message : 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'); refreshUser(); });
    $('#doSignin').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signInWithPassword({email,password}); alert(error? error.message : 'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„'); refreshUser(); });

    // Reset password (same site)
    const SITE_RESET_URL = location.origin + location.pathname.replace(/\/[^/]*$/, '/reset.html');
    $('#forgot').addEventListener('click', async ()=>{
      const email=$('#email').value.trim(); if(!email) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: SITE_RESET_URL });
      alert(error? error.message : 'Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¨Ø±ÙŠØ¯Ùƒ.');
    });

    $('#saveAll').addEventListener('click', saveAll);
    $('#recalc').addEventListener('click', async ()=>{
      // ØªØ­Ø¯ÙŠØ« Ù†ØªØ§Ø¦Ø¬ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
      const now = new Date(); const from = new Date(now.getTime()-7*864e5).toISOString().slice(0,10); const to = now.toISOString().slice(0,10);
      for(const c of FIXED_COMP_CODES){
        try{
          const url = `${EDGE_BASE}/competitions/${encodeURIComponent(c)}/matches?dateFrom=${from}&dateTo=${to}`;
          const res = await fetch(url, { headers: edgeHeaders });
          if(!res.ok) continue; const json = await res.json();
          const finished = (json.matches||[]).filter(x=> x.status==='FINISHED');
          for(const m of finished){
            await supabase.from('results').upsert({
              match_id: String(m.id),
              home_goals: m.score?.fullTime?.home,
              away_goals: m.score?.fullTime?.away,
              status: m.status
            });
          }
        }catch(_){}
      }
      renderLeaderboard(); renderWeekly();
    });

    fillWeekPicker();
    $('#loadWeek').addEventListener('click', renderWeekly);

    (async function start(){
      await refreshUser();
      await loadUserPreds();
      await loadMatches();
      renderMyUpcoming();
      renderLeaderboard();
      renderWeekly();
    })();
  }
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
