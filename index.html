<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osama – Mohammad Predictions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220;--bg2:#0f172a;--card:#0e1627;--muted:#a5b4c3;--text:#e8eef6;
    --accent:#22d3ee;--accent2:#10b981;--danger:#ef4444;--border:#1e293b;
    --ring:rgba(34,211,238,.35);--shadow:0 10px 30px rgba(0,0,0,.35)
  }
  /* Light theme */
  [data-theme="light"]{
    --bg:#f6f8fc;--bg2:#eef2f8;--card:#ffffff;--muted:#5b6574;--text:#0b1220;
    --accent:#0ea5e9;--accent2:#059669;--danger:#dc2626;--border:#e5e7eb;--ring:rgba(14,165,233,.35);
  }

  *{box-sizing:border-box}
  body{
    margin:0;background:radial-gradient(1200px 600px at 0 0, rgba(34,211,238,.06), transparent 40%),
             radial-gradient(900px 500px at 100% 0, rgba(16,185,129,.06), transparent 40%),
             linear-gradient(180deg,var(--bg),var(--bg2) 35%);
    color:var(--text);font-family:"Tajawal",system-ui,Arial
  }
  .container{max-width:1050px;margin:0 auto;padding:20px}
  header{display:flex;gap:12px;justify-content:space-between;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 8px var(--ring)}
  .card{
    position:relative;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),
              var(--card);
    border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow);
    backdrop-filter:saturate(140%) blur(4px)
  }
  .card::after{ /* خط متدرج لطيف على الحافة */
    content:"";position:absolute;inset:-1px;border-radius:18px;
    padding:1px;background:linear-gradient(135deg,rgba(34,211,238,.35),rgba(16,185,129,.2),transparent);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;transition:.2s}
  .chip:hover{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
  .chip[disabled]{opacity:.5;cursor:not-allowed}
  input,select{
    background:transparent;color:var(--text);border:1px solid var(--border);
    border-radius:12px;padding:9px 12px;outline:none;transition:.2s
  }
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 5px var(--ring)}
  .btn{
    background:linear-gradient(90deg,var(--accent),#7dd3fc);
    border:none;color:#06121a;font-weight:800;border-radius:12px;padding:10px 16px;cursor:pointer;transition:transform .06s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#1f2a3a;color:var(--text)}
  .btn.success{background:linear-gradient(90deg,var(--accent2),#34d399);color:#062a23}
  .btn.danger{background:linear-gradient(90deg,var(--danger),#fb7185);color:white}

  .grid{display:grid;gap:12px}
  .grid.matches{grid-template-columns:repeat(auto-fill,minmax(310px,1fr))}
  .muted{color:var(--muted)} .title{font-size:22px;font-weight:800} .small{font-size:12px}
  .center{text-align:center} .hidden{display:none}
  .kbd{font-family:ui-monospace,Menlo,monospace;background:transparent;border:1px dashed var(--border);padding:2px 6px;border-radius:6px}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
  .team{display:flex;align-items:center;gap:8px}
  .team img{width:26px;height:26px;object-fit:contain;background:transparent;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
  .score input{width:46px;text-align:center;font-weight:800}
  #debug{background:transparent;border:1px dashed var(--border);border-radius:12px;padding:10px;margin-bottom:10px;white-space:pre-wrap}

  .section-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

  /* جدول عام */
  .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  .table th,.table td{border-bottom:1px solid var(--border);padding:10px 10px;text-align:right}
  .table tr:nth-child(odd){background:rgba(255,255,255,.02)}
  .ok{color:#10b981}.bad{color:#ef4444}

  /* مداليات الترتيب */
  #board > .row{position:relative;padding-right:30px}
  #board > .row:nth-child(1)::before{content:"🥇";position:absolute;right:6px;top:6px}
  #board > .row:nth-child(2)::before{content:"🥈";position:absolute;right:6px;top:6px}
  #board > .row:nth-child(3)::before{content:"🥉";position:absolute;right:6px;top:6px}

  /* زر حفظ يطفو على الموبايل */
  @media (max-width:640px){
    #saveAll{position:fixed;right:16px;bottom:16px;z-index:50;border-radius:999px;padding:14px 18px;
      box-shadow:0 14px 40px rgba(0,0,0,.35)}
  }

  /* Toast */
  #toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;z-index:60;pointer-events:none}
  .toast{
    background:linear-gradient(180deg,rgba(255,255,255,.06),transparent), var(--card);
    border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:12px;
    box-shadow:var(--shadow);min-width:260px;text-align:center;pointer-events:auto;animation:pop .18s ease-out
  }
  .toast.ok{border-color:rgba(16,185,129,.6)}
  .toast.err{border-color:rgba(239,68,68,.7)}
  @keyframes pop{from{transform:translateY(10px);opacity:.0}to{transform:translateY(0);opacity:1}}
</style>

</head>
<body>
  <div class="container">
    <div id="debug" class="hidden"></div>

    <header>
      <div class="brand"><div class="dot"></div>
        <div>
          <div style="font-weight:700">Osama – Mohammad Predictions</div>
          <div class="muted small">لعبة توقع نتائج المباريات — مجانية 100%</div>
        </div>
      </div>
      <div class="row">
        <button id="btnLogin" class="chip">تسجيل / دخول</button>
        <button id="btnLogout" class="chip hidden">تسجيل خروج</button>
      </div>
    </header>

    <!-- Auth -->
    <section id="authCard" class="card hidden" style="margin-top:12px">
      <div class="title">حسابك</div>
      <div class="row" style="margin-top:8px">
        <input id="email" placeholder="الإيميل" type="email"/>
        <input id="password" placeholder="كلمة السر" type="password"/>
        <button id="doSignup" class="btn">إنشاء حساب</button>
        <button id="doSignin" class="btn secondary">دخول</button>
        <button id="forgot" class="chip">نسيت كلمة السر؟</button>
      </div>
      <div class="muted small" style="margin-top:8px">
        زر «نسيت كلمة السر» سيرسل لك إيميل إعادة تعيين إلى صفحة <code>reset.html</code> في نفس الموقع.
      </div>
    </section>

    <!-- Fixed scope summary -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">النطاق</div>
        <div id="whoami" class="muted small">—</div>
      </div>
      <div class="muted small">المسابقات: <strong>PD, CL, PL</strong> • الفرق المختارة: <strong id="fixedTeamCount">—</strong></div>
    </section>

    <!-- Matches -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">المباريات القادمة</div>
        <div class="row">
          <div class="muted small">التوقع مسموح حتى <span class="kbd">T-10m</span></div>
          <button id="saveAll" class="btn success">حفظ كل التوقعات</button>
        </div>
      </div>
      <div id="matches" class="grid matches"></div>
      <div id="noMatches" class="center muted hidden" style="margin-top:10px">لا يوجد مباريات ضمن ٤ أيام قادمة.</div>
    </section>

    <!-- My upcoming saved predictions -->
    <section class="card" style="margin-top:12px">
      <div class="section-head"><div class="title">سِجلي (محفوظ ولم يبدأ)</div></div>
      <div id="myUpcoming"></div>
    </section>

    <!-- Weekly history (all players) -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">التاريخ الأسبوعي</div>
        <div class="row">
          <select id="weekPick"></select>
          <button id="loadWeek" class="chip">عرض</button>
        </div>
      </div>
      <div id="weekly"></div>
    </section>

    <!-- Leaderboard -->
    <section class="card" style="margin-top:12px">
      <div class="section-head">
        <div class="title">الترتيب</div>
        <button id="recalc" class="chip">تحديث النقاط اليدوي</button>
      </div>
      <div id="board"></div>
    </section>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  /**** ===== إعدادات Supabase و Edge Function ===== ****/
  const SUPABASE_URL  = "https://wbxofuuwabwqurvbgfae.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndieG9mdXV3YWJ3cXVydmJnZmFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTUxNzQsImV4cCI6MjA3MTE5MTE3NH0.a45JBtzQI8so9z3lZ__aypUIafmhxeUOCkmBmbtQOHg";
  const EDGE_BASE     = "https://wbxofuuwabwqurvbgfae.supabase.co/functions/v1/bright-function"; // proxy

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const edgeHeaders = { 'Authorization': `Bearer ${SUPABASE_ANON}`, 'apikey': SUPABASE_ANON };

  /**** ===== نطاق ثابت ===== ****/
  const FIXED_COMP_CODES = ['PD','CL','PL'];
  const FIXED_TEAM_IDS = [
    81,86,4,5,524,57,58,61,62,63,64,65,66,67,71,73,76,328,341,351,354,397,402,563,1044
  ];
  document.getElementById('fixedTeamCount').textContent = String(FIXED_TEAM_IDS.length);

  /**** ===== Helpers ===== ****/
  const $ = (sel)=>document.querySelector(sel);
  const debugEl = $('#debug');
  function show(msg){ debugEl.textContent = msg; debugEl.classList.remove('hidden'); }
  function clearDebug(){ debugEl.classList.add('hidden'); debugEl.textContent = ''; }

  // وقت بأرقام إنجليزية
  const fmtTime = (iso)=> new Date(iso).toLocaleString('en-GB', { hour12:false });
  const crest = (id)=> `https://crests.football-data.org/${id}.svg`;

  function lockReason(kickoffISO){
    const k = new Date(kickoffISO).getTime();
    const diffMin = (k - Date.now()) / 60000;
    if(diffMin <= 10) return `مغلق (باقي ${Math.max(0, Math.floor(diffMin))} دقيقة)`;
    return null;
  }

  function pointsFor(pred, result){
    if(!result || result.status !== 'FINISHED') return 0;
    const ph=pred.home_goals, pa=pred.away_goals;
    const rh=result.home_goals, ra=result.away_goals;
    const predSign = Math.sign(ph-pa), realSign = Math.sign(rh-ra);
    if(ph===rh && pa===ra) return 3;
    if(predSign===realSign) return 1;
    return 0;
  }

  let USER=null;                       // user object
  const userPreds = new Map();         // match_id -> prediction
  const matchesMap = new Map();        // match_id -> match

  async function refreshUser(){
    const { data: { user } } = await supabase.auth.getUser();
    USER = user || null;
    const who = $('#whoami');
    if(user){
      $('#btnLogin').classList.add('hidden');
      $('#btnLogout').classList.remove('hidden');
      who.textContent = `مسجل: ${user.email}`;
      $('#authCard').classList.add('hidden');
      // خزّن/حدّث الإيميل في profiles لكي يظهر في الترتيب
      await supabase.from('profiles').upsert({ id:user.id, username:user.email });
    }else{
      $('#btnLogin').classList.remove('hidden');
      $('#btnLogout').classList.add('hidden');
      who.textContent = 'غير مسجل';
    }
  }

  // ===== جلب المباريات (٤ أيام فقط) =====
  async function fetchCompMatches(comp){
    const now  = new Date();
    const from = now.toISOString().slice(0,10);
    const to   = new Date(now.getTime()+4*864e5).toISOString().slice(0,10);
    const url  = `${EDGE_BASE}/competitions/${encodeURIComponent(comp)}/matches?dateFrom=${from}&dateTo=${to}`;
    const res  = await fetch(url, { headers: edgeHeaders });
    if(!res.ok){
      let msg = `API ${res.status}`; try{ const j = await res.json(); if(j && (j.message||j.error)) msg += ` — ${j.message||j.error}`; }catch(_){}
      throw new Error(`${msg} (المسابقة: ${comp})`);
    }
    const json = await res.json();
    return (json.matches || []).filter(m => ['TIMED','SCHEDULED'].includes(m.status));
  }

  // جلب مباريات لفترة معيّنة (للاسبوعي)
  async function fetchMatchesRange(fromISO, toISO){
    let all = [];
    for(const c of FIXED_COMP_CODES){
      const url  = `${EDGE_BASE}/competitions/${encodeURIComponent(c)}/matches?dateFrom=${fromISO}&dateTo=${toISO}`;
      const res  = await fetch(url, { headers: edgeHeaders });
      if(res.ok){
        const json = await res.json();
        all = all.concat(json.matches||[]);
      }
    }
    return all;
  }

  function renderMatchCard(m){
    const lock = lockReason(m.utcDate);
    const card = document.createElement('div');
    card.className = 'card';
    const kickoff = fmtTime(m.utcDate);
    const mid = String(m.id);
    const saved = userPreds.get(mid);

    matchesMap.set(mid, m);

    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="row">
            <div class="team"><img src="${crest(m.homeTeam.id)}" alt=""><span>${m.homeTeam.name}</span></div>
            <span class="muted">vs</span>
            <div class="team"><img src="${crest(m.awayTeam.id)}" alt=""><span>${m.awayTeam.name}</span></div>
          </div>
          <div class="muted small">${m.competition.name} • ${kickoff}</div>
        </div>
        <div class="pill ${lock? 'muted':''}" id="pill_${mid}">${lock? lock : (saved? 'محفوظ' : 'مفتوح')}</div>
      </div>
      <div class="row score" style="margin-top:8px">
        <input type="number" min="0" id="h_${mid}" placeholder="${m.homeTeam.tla||'H'}">
        <span class="muted">—</span>
        <input type="number" min="0" id="a_${mid}" placeholder="${m.awayTeam.tla||'A'}">
      </div>
    `;
    $('#matches').appendChild(card);

    if(saved){
      card.querySelector(`#h_${mid}`).value = saved.home_goals;
      card.querySelector(`#a_${mid}`).value = saved.away_goals;
      card.querySelector(`#h_${mid}`).disabled = true;
      card.querySelector(`#a_${mid}`).disabled = true;
    }
    if(lock){
      card.querySelector(`#h_${mid}`).disabled = true;
      card.querySelector(`#a_${mid}`).disabled = true;
    }
  }

  async function saveAll(){
    if(!USER) return alert('سجل دخول بالأول');
    const rows = [];
    document.querySelectorAll('[id^="h_"]').forEach(inp=>{
      const mid = inp.id.slice(2);
      const a = document.getElementById(`a_${mid}`);
      const pillTxt = document.getElementById(`pill_${mid}`).textContent;
      const locked = pillTxt.startsWith('مغلق');
      if(locked) return;
      if(userPreds.has(mid)) return; // لا تعديل بعد الحفظ
      const hV = parseInt(inp.value,10), aV = parseInt(a.value,10);
      if(Number.isNaN(hV)||Number.isNaN(aV)) return;
      const m = matchesMap.get(mid);
      rows.push({
        user_id: USER.id,
        match_id: mid,
        home_goals: hV,
        away_goals: aV,
        kickoff: m ? new Date(m.utcDate).toISOString() : new Date().toISOString(),
        comp_id: m?.competition?.code || null,
        team_home: m?.homeTeam?.name || null,
        team_away: m?.awayTeam?.name || null
      });
    });
    if(!rows.length) return alert('ما في توقعات جديدة للحفظ');
    const { error } = await supabase.from('predictions').insert(rows);
    if(error){
      alert('انحفظت التوقعات المتاحة (تجاهلنا اللي محفوظة سابقًا)');
    }else{
      alert('تم الحفظ ✌️');
    }
    await loadUserPreds(); markSavedOnUI(); renderMyUpcoming();
  }

  function markSavedOnUI(){
    document.querySelectorAll('[id^="h_"]').forEach(inp=>{
      const mid = inp.id.slice(2);
      const saved = userPreds.get(mid);
      if(saved){
        inp.value = saved.home_goals;
        const a = document.getElementById(`a_${mid}`);
        a.value = saved.away_goals;
        inp.disabled = true; a.disabled = true;
        const pill = document.getElementById('pill_'+mid); if(pill) pill.textContent = 'محفوظ';
      }
    });
  }

  // ====== LEADERBOARD (يعرض الجميع حتى لو 0 نقطة) ======
  async function renderLeaderboard(){
    const [profsRes, predsRes, resRes] = await Promise.all([
      supabase.from('profiles').select('id,username'),
      supabase.from('predictions').select('*'),
      supabase.from('results').select('*')
    ]);

    const profs   = profsRes.data || [];
    const preds   = predsRes.data || [];
    const results = resRes.data   || [];

    // خريطة النتائج الفعلية
    const rmap = new Map(results.map(r => [String(r.match_id), r]));

    // حساب النقاط من التوقعات
    const totals = new Map();
    for(const p of preds){
      const r = rmap.get(String(p.match_id));
      const pts = pointsFor(p, r);
      totals.set(p.user_id, (totals.get(p.user_id)||0) + pts);
    }

    // تأكد إدراج كل المستخدمين حتى لو 0
    for(const prof of profs){
      if(!totals.has(prof.id)) totals.set(prof.id, 0);
    }

    // أسماء
    const names = {};
    for(const prof of profs){
      names[prof.id] = prof.username || prof.id.slice(0,8);
    }

    // ترتيب
    const sorted = [...totals.entries()].sort((a,b) =>
      (b[1]-a[1]) || (names[a[0]]||'').localeCompare(names[b[0]]||'')
    );

    const html = sorted.map(([uid,pts],i)=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:6px 0">
        <div>#${i+1} • ${names[uid]||uid.slice(0,8)}</div>
        <div><strong>${pts}</strong> نقطة</div>
      </div>`).join('');

    document.querySelector('#board').innerHTML = html || '<div class="muted">لا يوجد مشاركون بعد.</div>';
  }

  async function loadUserPreds(){
    if(!USER){ userPreds.clear(); return; }
    const {data} = await supabase.from('predictions')
      .select('match_id,home_goals,away_goals,kickoff,team_home,team_away')
      .eq('user_id', USER.id);
    userPreds.clear();
    (data||[]).forEach(p=> userPreds.set(String(p.match_id), p));
  }

  // سِجلي (محفوظ ولم يبدأ)
  async function renderMyUpcoming(){
    if(!USER){ $('#myUpcoming').innerHTML = '<div class="muted">سجّل دخول لعرض سجلك.</div>'; return; }
    const now = new Date(); const in4 = new Date(now.getTime()+4*864e5);
    const mine = [...userPreds.values()].filter(p=> new Date(p.kickoff) > now && new Date(p.kickoff) <= in4 );
    if(!mine.length){ $('#myUpcoming').innerHTML = '<div class="muted">لا يوجد توقعات محفوظة ضمن ٤ أيام.</div>'; return; }
    $('#myUpcoming').innerHTML = `
      <table class="table">
        <thead><tr><th>المباراة</th><th>التوقع</th><th>الوقت</th></tr></thead>
        <tbody id="myUpcomingBody"></tbody>
      </table>`;
    const body = document.getElementById('myUpcomingBody');
    for(const p of mine){
      const m = matchesMap.get(String(p.match_id));
      const label = m ? `${m.homeTeam.name} vs ${m.awayTeam.name}` : `${p.team_home||''} vs ${p.team_away||''}`.trim();
      body.insertAdjacentHTML('beforeend',
        `<tr><td>${label}</td><td>${p.home_goals} – ${p.away_goals}</td><td>${fmtTime(p.kickoff)}</td></tr>`);
    }
  }

  // Weekly history (all users) مع التوقع + النتيجة + النقاط
  function startOfWeek(d){
    const dt = new Date(d); const day = (dt.getDay()+6)%7; // Monday=0
    dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day); return dt;
  }
  function endOfWeek(s){ const e=new Date(s); e.setDate(e.getDate()+7); return e; }
  function fillWeekPicker(){
    const now = new Date();
    const cur = startOfWeek(now); const prev = new Date(cur); prev.setDate(cur.getDate()-7);
    const sel = document.getElementById('weekPick');
    sel.innerHTML = `
      <option value="cur">الأسبوع الحالي (${cur.toLocaleDateString('en-GB')})</option>
      <option value="prev">الأسبوع السابق (${prev.toLocaleDateString('en-GB')})</option>`;
  }
  async function renderWeekly(){
    const pick = document.getElementById('weekPick').value;
    const base = pick==='prev'? startOfWeek(new Date(new Date().setDate(new Date().getDate()-7))) : startOfWeek(new Date());
    const from = base.toISOString().slice(0,10), to = endOfWeek(base).toISOString().slice(0,10);

    const [predsRes, resRes] = await Promise.all([
      supabase.from('predictions').select('*').gte('kickoff', base.toISOString()).lt('kickoff', endOfWeek(base).toISOString()),
      supabase.from('results').select('*')
    ]);
    const preds = predsRes.data || [];
    const res   = resRes.data   || [];
    const rmap  = new Map(res.map(r=>[String(r.match_id), r]));
    const weekMatches = await fetchMatchesRange(from, to);
    const wmap = new Map(weekMatches.map(m=>[String(m.id), m]));

    // group by user
    const byUser = new Map();
    for(const p of preds){ const arr = byUser.get(p.user_id)||[]; arr.push(p); byUser.set(p.user_id, arr); }

    // emails
    const names = {};
    for(const uid of byUser.keys()){
      const {data} = await supabase.from('profiles').select('id,username').eq('id', uid).maybeSingle();
      names[uid] = data?.username || uid.slice(0,8);
    }

    let html = '';
    for(const [uid,list] of byUser.entries()){
      let total=0;
      const rows = list.map(p=>{
        const mid = String(p.match_id);
        const m = wmap.get(mid);
        const label = m ? `${m.homeTeam.name} vs ${m.awayTeam.name}`
                        : `${p.team_home||''} vs ${p.team_away||''}`.trim() || mid;

        const r = rmap.get(mid) || (m && m.status==='FINISHED' && m.score ? {
          match_id: mid,
          home_goals: m.score.fullTime.home,
          away_goals: m.score.fullTime.away,
          status: m.status
        } : null);

        const resText = r ? `${r.home_goals} – ${r.away_goals}` : '—';
        const pts = pointsFor(p, r); total += pts;
        const cls = r ? (pts>0? 'ok':'bad') : '';
        return `<tr><td>${label}</td><td>${p.home_goals} – ${p.away_goals}</td><td>${resText}</td><td class="${cls}">${r? pts : ''}</td></tr>`;
      }).join('');

      html += `<div class="title" style="margin-top:6px">${names[uid]||uid.slice(0,8)} — <span class="muted small">المجموع: ${total}</span></div>
        <table class="table" style="margin:6px 0 12px 0">
          <thead><tr><th>المباراة</th><th>التوقع</th><th>النتيجة</th><th>النقاط</th></tr></thead>
          <tbody>${rows||''}</tbody>
        </table>`;
    }
    $('#weekly').innerHTML = html || '<div class="muted">لا يوجد بيانات لهذا الأسبوع.</div>';
  }

  // ===== تهيئة الصفحة =====
  async function loadMatches(){
    clearDebug();
    $('#matches').innerHTML = ''; $('#noMatches').classList.add('hidden'); matchesMap.clear();

    let all = [];
    for(const c of FIXED_COMP_CODES){
      try{ all = all.concat(await fetchCompMatches(c)); }
      catch(e){ show(e.message); }
    }
    // فلترة حسب الفرق الثابتة
    const wanted = new Set(FIXED_TEAM_IDS.map(String));
    all = all.filter(m=> wanted.has(String(m.homeTeam.id)) || wanted.has(String(m.awayTeam.id)) );
    if(!all.length){ $('#noMatches').classList.remove('hidden'); return; }
    all.sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate));
    all.forEach(renderMatchCard);
    markSavedOnUI();
  }

  function init(){
    window.addEventListener('error', (e)=> show('JS Error: '+ e.message));
    window.addEventListener('unhandledrejection', (e)=> show('Promise Error: '+ (e.reason?.message||e.reason)));

    // Auth
    $('#btnLogin').addEventListener('click', ()=> $('#authCard').classList.toggle('hidden'));
    $('#btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); await refreshUser(); });
    $('#doSignup').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signUp({email,password}); alert(error? error.message : 'تم إنشاء الحساب'); refreshUser(); });
    $('#doSignin').addEventListener('click', async ()=>{ const email=$('#email').value, password=$('#password').value; const {error} = await supabase.auth.signInWithPassword({email,password}); alert(error? error.message : 'تم الدخول'); refreshUser(); });

    // Reset password (same site)
    const SITE_RESET_URL = location.origin + location.pathname.replace(/\/[^/]*$/, '/reset.html');
    $('#forgot').addEventListener('click', async ()=>{
      const email=$('#email').value.trim(); if(!email) return alert('اكتب الإيميل أولًا');
      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: SITE_RESET_URL });
      alert(error? error.message : 'أرسلنا رابط تغيير كلمة السر لبريدك.');
    });

    $('#saveAll').addEventListener('click', saveAll);
    $('#recalc').addEventListener('click', async ()=>{
      // تحديث نتائج آخر 7 أيام
      const now = new Date(); const from = new Date(now.getTime()-7*864e5).toISOString().slice(0,10); const to = now.toISOString().slice(0,10);
      for(const c of FIXED_COMP_CODES){
        try{
          const url = `${EDGE_BASE}/competitions/${encodeURIComponent(c)}/matches?dateFrom=${from}&dateTo=${to}`;
          const res = await fetch(url, { headers: edgeHeaders });
          if(!res.ok) continue; const json = await res.json();
          const finished = (json.matches||[]).filter(x=> x.status==='FINISHED');
          for(const m of finished){
            await supabase.from('results').upsert({
              match_id: String(m.id),
              home_goals: m.score?.fullTime?.home,
              away_goals: m.score?.fullTime?.away,
              status: m.status
            });
          }
        }catch(_){}
      }
      renderLeaderboard(); renderWeekly();
    });

    fillWeekPicker();
    $('#loadWeek').addEventListener('click', renderWeekly);

    (async function start(){
      await refreshUser();
      await loadUserPreds();
      await loadMatches();
      renderMyUpcoming();
      renderLeaderboard();
      renderWeekly();
    })();
  }
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
