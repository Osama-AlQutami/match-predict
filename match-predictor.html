<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Match Predictor — لعبة التوقعات</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--danger:#ef4444;--ok:#10b981;--border:#1f2937
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 30%);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center}
    .brand{display:flex;gap:12px;align-items:center}
    .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(34,211,238,.15)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:#0b1220;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .chip[disabled]{opacity:.5;cursor:not-allowed}
    input,select{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .btn{background:var(--accent);border:none;color:#0b1220;font-weight:700;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#1f2937;color:var(--text)}
    .btn.danger{background:var(--danger);color:white}
    .grid{display:grid;gap:10px}
    .grid.matches{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .muted{color:var(--muted)}
    .title{font-size:22px;font-weight:700}
    .small{font-size:12px}
    .center{text-align:center}
    .hidden{display:none}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:#0b1220;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><div class="dot"></div>
        <div>
          <div style="font-weight:700">Match Predictor</div>
          <div class="muted small">لعبة توقع نتائج المباريات — مجانية 100%</div>
        </div>
      </div>
      <div class="row">
        <button id="btnLogin" class="chip">تسجيل / دخول</button>
        <button id="btnLogout" class="chip hidden">تسجيل خروج</button>
      </div>
    </header>

    <!-- Auth -->
    <section id="authCard" class="card hidden" style="margin-top:12px">
      <div class="title">حسابك</div>
      <div class="row" style="margin-top:8px">
        <input id="email" placeholder="الإيميل" type="email"/>
        <input id="password" placeholder="كلمة السر" type="password"/>
        <button id="doSignup" class="btn">إنشاء حساب</button>
        <button id="doSignin" class="btn secondary">دخول</button>
      </div>
      <div class="muted small" style="margin-top:8px">نستعمل Supabase مجانًا للمصادقة وتخزين النتائج.</div>
    </section>

    <!-- Admin: choose competitions & teams -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">الإعدادات</div>
        <div id="whoami" class="muted small">—</div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="competitionIds" placeholder="IDs المسابقات (مثلاً: PL, CLU)" style="min-width:260px"/>
        <input id="teamIds" placeholder="IDs الفرق (comma-separated اختياري)" style="min-width:260px"/>
        <button id="saveScope" class="btn">حفظ الفرق/المسابقات</button>
      </div>
      <div class="muted small" style="margin-top:6px">نستعمل API مجاني من football-data.org — حط التوكن تبعك تحت.
        <span class="pill">مجاني</span>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="footballToken" placeholder="Football-Data API Token" style="min-width:360px"/>
        <button id="saveToken" class="chip">حفظ التوكن محليًا</button>
      </div>
    </section>

    <!-- Upcoming matches & predictions -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">المباريات القادمة</div>
        <div class="muted small">التوقع مسموح حتى <span class="kbd">T-30m</span> قبل انطلاق المباراة.</div>
      </div>
      <div id="matches" class="grid matches" style="margin-top:10px"></div>
      <div id="noMatches" class="center muted hidden" style="margin-top:10px">لا يوجد مباريات ضمن النطاق الحالي.</div>
    </section>

    <!-- Leaderboard -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">الترتيب</div>
        <button id="recalc" class="chip">تحديث النقاط اليدوي</button>
      </div>
      <div id="board" style="margin-top:8px"></div>
    </section>
  </div>

  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  /**** ======== الإعدادات (بدّل القيم أدناه) ======== ****/
  const SUPABASE_URL = "https://wbxofuuwabwqurvbgfae.supabase.co"; // ← تم التعديل
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndieG9mdXV3YWJ3cXVydmJnZmFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTUxNzQsImV4cCI6MjA3MTE5MTE3NH0.a45JBtzQI8so9z3lZ__aypUIafmhxeUOCkmBmbtQOHg";                     // ← تم التعديل
  // ملاحظة: توكن football-data نحفظه في localStorage عندك كـ FOOTBALL_TOKEN

  // مسابقات افتراضية (تقدر تغير من الواجهة):
  // PL=Premier League, BL1=Bundesliga, PD=La Liga, SA=Serie A, FL1=Ligue 1
  const DEFAULT_COMP_IDS = "PL,PD,SA,BL1,FL1";

  /**** ======== Supabase init ======== ****/
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /**** ======== Helpers ======== ****/
  const $ = (sel)=>document.querySelector(sel);
  const matchesEl = $('#matches');
  const noMatchesEl = $('#noMatches');
  const boardEl = $('#board');
  const whoamiEl = $('#whoami');

  const FOOTBALL_BASE = 'https://api.football-data.org/v4';
  const getToken = ()=> localStorage.getItem('FOOTBALL_TOKEN') || '';
  const saveToken = (t)=> localStorage.setItem('FOOTBALL_TOKEN', t);

  const getScope = ()=>({
    comps: (localStorage.getItem('COMP_IDS')||DEFAULT_COMP_IDS).split(',').map(x=>x.trim()).filter(Boolean),
    teams: (localStorage.getItem('TEAM_IDS')||'').split(',').map(x=>x.trim()).filter(Boolean)
  });
  const saveScope = (comps, teams)=>{
    localStorage.setItem('COMP_IDS', comps);
    localStorage.setItem('TEAM_IDS', teams);
  }

  const fmtTime = (iso)=> new Date(iso).toLocaleString('ar-JO');

  function lockReason(kickoffISO){
    const k = new Date(kickoffISO).getTime();
    const now = Date.now();
    const diffMin = (k - now) / 60000;
    if(diffMin <= 30) return `مغلق (باقي ${Math.max(0, Math.floor(diffMin))} دقيقة)`;
    return null;
  }

  function pointsFor(pred, result){
    if(!result || result.status !== 'FINISHED') return 0;
    const ph=pred.home_goals, pa=pred.away_goals;
    const rh=result.home_goals, ra=result.away_goals;
    const predSign = Math.sign(ph-pa), realSign = Math.sign(rh-ra);
    if(ph===rh && pa===ra) return 3; // exact
    if(predSign===realSign) return 1; // correct outcome (فائز/تعادل)
    return 0;
  }

  /**** ======== Auth UI ======== ****/
  async function refreshUser(){
    const { data: { user } } = await supabase.auth.getUser();
    if(user){
      $('#btnLogin').classList.add('hidden');
      $('#btnLogout').classList.remove('hidden');
      whoamiEl.textContent = `مسجل: ${user.email}`;
      $('#authCard').classList.add('hidden');
    }else{
      $('#btnLogin').classList.remove('hidden');
      $('#btnLogout').classList.add('hidden');
      whoamiEl.textContent = 'غير مسجل';
    }
  }

  $('#btnLogin').onclick = ()=> $('#authCard').classList.toggle('hidden');
  $('#btnLogout').onclick = async ()=>{ await supabase.auth.signOut(); await refreshUser(); };
  $('#doSignup').onclick = async ()=>{
    const {email, password} = {email: $('#email').value, password: $('#password').value};
    const {error} = await supabase.auth.signUp({email,password});
    alert(error? error.message : 'تم إنشاء الحساب. افحص بريدك للتأكيد (إن طُلِب).');
    refreshUser();
  };
  $('#doSignin').onclick = async ()=>{
    const {email, password} = {email: $('#email').value, password: $('#password').value};
    const {error} = await supabase.auth.signInWithPassword({email,password});
    alert(error? error.message : 'تم الدخول');
    refreshUser();
  };

  // Save scope/token
  $('#saveScope').onclick = ()=>{
    saveScope($('#competitionIds').value, $('#teamIds').value);
    loadMatches();
  }
  $('#saveToken').onclick = ()=>{
    saveToken($('#footballToken').value);
    loadMatches();
  }

  /**** ======== Fetch fixtures from Football-Data ======== ****/
  async function fetchCompMatches(comp){
    const token = getToken();
    const headers = token? { 'X-Auth-Token': token } : {};
    // Upcoming in next 7 days
    const now = new Date();
    const from = now.toISOString().slice(0,10);
    const to = new Date(now.getTime()+7*864e5).toISOString().slice(0,10);
    const url = `${FOOTBALL_BASE}/competitions/${encodeURIComponent(comp)}/matches?dateFrom=${from}&dateTo=${to}`;
    const res = await fetch(url, {headers});
    if(!res.ok) throw new Error('API error '+res.status);
    const json = await res.json();
    return json.matches || [];
  }

  async function loadMatches(){
    matchesEl.innerHTML = ''; noMatchesEl.classList.add('hidden');
    const scope = getScope();
    $('#competitionIds').value = scope.comps.join(',');
    $('#teamIds').value = scope.teams.join(',');
    $('#footballToken').value = getToken();
    try{
      let all = [];
      for(const c of scope.comps){
        const part = await fetchCompMatches(c);
        all = all.concat(part);
      }
      // filter by teams if provided
      if(scope.teams.length){
        all = all.filter(m=> scope.teams.includes(String(m.homeTeam.id)) || scope.teams.includes(String(m.awayTeam.id)) );
      }
      // upcoming only
      all = all.filter(m=> ['TIMED','SCHEDULED'].includes(m.status));
      if(!all.length){ noMatchesEl.classList.remove('hidden'); return; }
      all.sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate));
      all.forEach(renderMatchCard);
    }catch(e){
      console.error(e);
      noMatchesEl.classList.remove('hidden');
      noMatchesEl.textContent = 'تعذر جلب البيانات. تأكد من التوكن أو المعرّفات.';
    }
  }

  function renderMatchCard(m){
    const lock = lockReason(m.utcDate);
    const card = document.createElement('div');
    card.className = 'card';
    const kickoff = fmtTime(m.utcDate);
    const mid = m.id; // football-data match id
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="title">${m.homeTeam.name} <span class="muted">vs</span> ${m.awayTeam.name}</div>
          <div class="muted small">${m.competition.name} • ${kickoff}</div>
        </div>
        <div class="pill ${lock? 'muted':''}">${lock? lock : 'مفتوح للتوقع'}</div>
      </div>
      <div class="row" style="margin-top:8px;align-items:center">
        <input type="number" min="0" id="h_${mid}" placeholder="${m.homeTeam.tla||'H'}" style="width:90px">
        <span class="muted">—</span>
        <input type="number" min="0" id="a_${mid}" placeholder="${m.awayTeam.tla||'A'}" style="width:90px">
        <button class="btn" id="s_${mid}">حفظ التوقع</button>
      </div>
    `;
    matchesEl.appendChild(card);

    const saveBtn = card.querySelector(`#s_${mid}`);
    saveBtn.onclick = ()=> savePrediction(m);
    if(lock){ saveBtn.disabled = true; }
  }

  async function savePrediction(m){
    const h = parseInt(document.getElementById(`h_${m.id}`).value, 10);
    const a = parseInt(document.getElementById(`a_${m.id}`).value, 10);
    if(Number.isNaN(h)||Number.isNaN(a)) return alert('حط النتيجة للطرفين');
    const lock = lockReason(m.utcDate); if(lock) return alert('انتهى الوقت للتوقع');
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) return alert('سجل دخول بالأول');
    const row = {
      user_id: user.id,
      match_id: String(m.id),
      home_goals: h,
      away_goals: a,
      kickoff: new Date(m.utcDate).toISOString(),
      comp_id: m.competition.code || m.competition.id,
      team_home: m.homeTeam.name,
      team_away: m.awayTeam.name
    };
    const {error} = await supabase.from('predictions').upsert(row, {onConflict: 'user_id,match_id'});
    alert(error? error.message : 'انحفظ التوقع ✌️');
  }

  /**** ======== Leaderboard (simple) ======== ****/
  async function recalcScores(){
    // Pull finished results for last 7 days for the same competitions
    const token = getToken(); const headers = token? { 'X-Auth-Token': token } : {};
    const scope = getScope();
    const now = new Date();
    const from = new Date(now.getTime()-7*864e5).toISOString().slice(0,10);
    const to = now.toISOString().slice(0,10);
    for(const c of scope.comps){
      const url = `${FOOTBALL_BASE}/competitions/${encodeURIComponent(c)}/matches?dateFrom=${from}&dateTo=${to}`;
      const res = await fetch(url,{headers});
      if(!res.ok) continue; const json = await res.json();
      const finished = (json.matches||[]).filter(x=> x.status==='FINISHED');
      for(const m of finished){
        await supabase.from('results').upsert({
          match_id: String(m.id),
          home_goals: m.score.fullTime.home,
          away_goals: m.score.fullTime.away,
          status: m.status
        });
      }
    }
    renderLeaderboard();
  }

  async function renderLeaderboard(){
    const {data: preds} = await supabase.from('predictions').select('*');
    const {data: res} = await supabase.from('results').select('*');
    const map = new Map(res?.map(r=>[r.match_id, r]));
    const totals = new Map();
    for(const p of (preds||[])){
      const r = map.get(p.match_id);
      const pts = pointsFor(p, r);
      const cur = totals.get(p.user_id)||0; totals.set(p.user_id, cur+pts);
    }
    // Map user ids to emails
    const ids = [...totals.keys()];
    const users = {};
    for(const id of ids){
      const {data} = await supabase.from('profiles').select('id,username').eq('id', id).maybeSingle();
      users[id] = data?.username || id.slice(0,8);
    }
    const sorted = [...totals.entries()].sort((a,b)=> b[1]-a[1]);
    const html = sorted.map(([uid,pts],i)=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:8px 0">
      <div>#${i+1} • ${users[uid]}</div><div><strong>${pts}</strong> نقطة</div>
    </div>`).join('');
    boardEl.innerHTML = html || '<div class="muted">لا يوجد نقاط بعد.</div>';
  }

  $('#recalc').onclick = recalcScores;

  // start
  (async function init(){
    await refreshUser();
    await loadMatches();
    renderLeaderboard();
  })();
  </script>
</body>
</html>
